<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор налогов для ИП</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #ffffff;
            font-weight: 600;
        }

        .description {
            color: #a0a0a0;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .error {
            background-color: #2d1515;
            border: 1px solid #5a2121;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 500;
        }

        input[type="number"],
        input[type="text"] {
            background-color: #0f0f0f;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            color: #e0e0e0;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .fot-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #151515;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .fot-label {
            grid-column: 1 / -1;
            font-size: 15px;
            color: #d0d0d0;
            font-weight: 600;
            margin-bottom: -10px;
        }

        .month-help {
            grid-column: 1 / -1;
            font-size: 12px;
            color: #808080;
            margin-top: -5px;
        }

        .month-summary {
            grid-column: 1 / -1;
            font-size: 12px;
            margin-top: 4px;
        }

        .month-summary span {
            font-weight: 600;
        }

        button {
            background-color: #3a7bc8;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: #4a8fd8;
        }

        button:active {
            transform: scale(0.98);
        }

        .results-section {
            margin-top: 40px;
        }

        .results-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th {
            background-color: #0f0f0f;
            color: #b0b0b0;
            font-weight: 600;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #2a2a2a;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #2a2a2a;
            font-size: 14px;
        }

        tr:hover {
            background-color: #222222;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .regime-name {
            font-weight: 500;
            color: #ffffff;
        }

        .number-cell {
            text-align: center;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .unavailable {
            color: #666666;
            font-style: italic;
        }

        .positive {
            color: #6bcf7f;
        }

        .negative {
            color: #ff6b6b;
        }

        .details-row td {
            background-color: #141414;
            border-top: none;
            border-bottom: 1px solid #2a2a2a;
            padding-top: 8px;
            padding-bottom: 12px;
        }

        .details-box {
            font-size: 13px;
            color: #c0c0c0;
            line-height: 1.5;
        }

        .details-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
        }

        .details-box p {
            margin-bottom: 4px;
        }

        .details-box p:last-child {
            margin-bottom: 0;
        }

        .regime-row {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .form-section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .fot-group {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 20px;
            }

            .table-wrapper {
                padding: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Калькулятор налогов для ИП</h1>
        <p class="description">Сравнение режимов налогообложения с учётом законодательства 2026 года</p>

        {% if error %}
        <div class="error">
            {{ error }}
        </div>
        {% endif %}

        <div class="form-section">
            <form method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="revenue">Выручка в год, ₽ *</label>
                        <input type="number" id="revenue" name="revenue" step="0.01" required
                               value="{{ form_data.revenue if form_data else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="cost_percent">Себестоимость, % от выручки</label>
                        <input type="number" id="cost_percent" name="cost_percent" step="0.01" min="0" max="100"
                               value="{{ form_data.cost_percent if form_data else '40' }}">
                    </div>

                    <div class="form-group">
                        <label for="vat_purchases_percent">Процент закупок с НДС, %</label>
                        <input type="number" id="vat_purchases_percent" name="vat_purchases_percent" step="0.01" min="0" max="100"
                               value="{{ form_data.vat_purchases_percent if form_data else '70' }}">
                    </div>

                    <div class="form-group">
                        <label for="rent">Аренда в год, ₽</label>
                        <input type="number" id="rent" name="rent" step="0.01"
                               value="{{ form_data.rent if form_data else '0' }}">
                    </div>

                    <div class="form-group">
                        <label for="accumulated_vat_credit">Накопленный НДС к вычету за прошлые периоды, ₽</label>
                        <input
                            type="number"
                            id="accumulated_vat_credit"
                            name="accumulated_vat_credit"
                            step="0.01"
                            min="0"
                            value="{{ form_data.accumulated_vat_credit if form_data else '0' }}"
                        >
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Прочие расходы</label>

                        <div style="margin-bottom: 10px;">
                            <label style="margin-right: 20px;">
                                <input type="radio" name="other_mode" value="percent"
                                    {% if form_data.other_mode != 'absolute' %}checked{% endif %}>
                                В процентах
                            </label>
                            <label>
                                <input type="radio" name="other_mode" value="absolute"
                                    {% if form_data.other_mode == 'absolute' %}checked{% endif %}>
                                В рублях
                            </label>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="other_percent">Проценты (%)</label>
                                <input type="number" id="other_percent" name="other_percent" step="0.01" min="0" max="100"
                                    value="{{ form_data.other_percent }}"
                                    {% if form_data.other_mode == 'absolute' %}readonly{% endif %}>
                            </div>

                            <div>
                                <label for="other_amount">Сумма (₽ в год)</label>
                                <input type="number" id="other_amount" name="other_amount" step="0.01" min="0"
                                    value="{{ form_data.other_amount }}"
                                    {% if form_data.other_mode != 'absolute' %}readonly{% endif %}>
                            </div>
                        </div>
                    </div>

                    <div class="fot-group">
                        <div class="fot-label">Фонд оплаты труда (ФОТ)</div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Способ задания ФОТ</label>
                            <div style="margin-top: 4px; margin-bottom: 12px;">
                                <label style="margin-right: 20px;">
                                    <input type="radio" name="fot_mode" value="staff"
                                        {% if form_data.fot_mode != 'annual' %}checked{% endif %}>
                                    По сотрудникам (количество × оклад)
                                </label>
                                <label>
                                    <input type="radio" name="fot_mode" value="annual"
                                        {% if form_data.fot_mode == 'annual' %}checked{% endif %}>
                                    ФОТ суммой за год
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="employees">Количество сотрудников</label>
                            <input type="number" id="employees" name="employees" min="0" step="1"
                                value="{{ form_data.employees if form_data else '0' }}">
                        </div>

                        <div class="form-group">
                            <label for="salary">Оклад одного сотрудника в месяц, ₽</label>
                            <input type="number" id="salary" name="salary" step="0.01"
                                value="{{ form_data.salary if form_data else '0' }}">
                        </div>

                        <div class="form-group">
                            <label for="fot_annual">ФОТ за год, ₽</label>
                            <input type="number" id="fot_annual" name="fot_annual" step="0.01" min="0"
                                value="{{ form_data.fot_annual if form_data else '' }}">
                        </div>

                        <p class="month-help" style="grid-column: 1 / -1; margin-top: 4px;">
                            В режиме «по сотрудникам» ФОТ за год считается как:
                            <strong>количество сотрудников × оклад × 12</strong> и подставляется автоматически.
                            В режиме «ФОТ суммой за год» используется только введённая сумма — поля сотрудников и оклады
                            на расчёт не влияют.
                        </p>
                    </div>


                    <div class="fot-group">
                        <div class="fot-label">
                            Коэффициент закупок по месяцам (100 — обычный месяц, для АУСН 20%)
                        </div>

                        <div class="form-group">
                            <label for="purchases_jan">Январь</label>
                            <input type="number" id="purchases_jan" name="purchases_jan" step="0.01" min="0"
                                   value="{{ form_data.purchases_jan if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_feb">Февраль</label>
                            <input type="number" id="purchases_feb" name="purchases_feb" step="0.01" min="0"
                                   value="{{ form_data.purchases_feb if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_mar">Март</label>
                            <input type="number" id="purchases_mar" name="purchases_mar" step="0.01" min="0"
                                   value="{{ form_data.purchases_mar if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_apr">Апрель</label>
                            <input type="number" id="purchases_apr" name="purchases_apr" step="0.01" min="0"
                                   value="{{ form_data.purchases_apr if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_may">Май</label>
                            <input type="number" id="purchases_may" name="purchases_may" step="0.01" min="0"
                                   value="{{ form_data.purchases_may if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_jun">Июнь</label>
                            <input type="number" id="purchases_jun" name="purchases_jun" step="0.01" min="0"
                                   value="{{ form_data.purchases_jun if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_jul">Июль</label>
                            <input type="number" id="purchases_jul" name="purchases_jul" step="0.01" min="0"
                                   value="{{ form_data.purchases_jul if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_aug">Август</label>
                            <input type="number" id="purchases_aug" name="purchases_aug" step="0.01" min="0"
                                   value="{{ form_data.purchases_aug if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_sep">Сентябрь</label>
                            <input type="number" id="purchases_sep" name="purchases_sep" step="0.01" min="0"
                                   value="{{ form_data.purchases_sep if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_oct">Октябрь</label>
                            <input type="number" id="purchases_oct" name="purchases_oct" step="0.01" min="0"
                                   value="{{ form_data.purchases_oct if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_nov">Ноябрь</label>
                            <input type="number" id="purchases_nov" name="purchases_nov" step="0.01" min="0"
                                   value="{{ form_data.purchases_nov if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_dec">Декабрь</label>
                            <input type="number" id="purchases_dec" name="purchases_dec" step="0.01" min="0"
                                   value="{{ form_data.purchases_dec if form_data else '100' }}">
                        </div>

                        <p class="month-help">
                            Укажите <strong>относительную нагрузку закупок</strong> по месяцам.
                            Значение <strong>100</strong> означает обычный уровень закупок.
                            Если в каком-то месяце закупок в 2 раза больше среднего — поставьте <strong>200</strong>,
                            если в 2 раза меньше — <strong>50</strong>.
                            Сумма значений может быть любой — калькулятор сам нормализует их.
                        </p>

                        <p class="month-summary">
                            Сумма коэффициентов: <span id="coef-sum">–</span>
                            (<span id="coef-percent">–</span>% от базового уровня 1200)
                        </p>
                    </div>
                </div>

                <button type="submit">Рассчитать</button>
            </form>
        </div>

        {% if top_results %}
        <div class="results-section">
            <h2 class="results-title">Топ-5 режимов с минимальной налоговой нагрузкой</h2>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Режим</th>
                            <th class="number-cell">Налог. нагрузка, ₽</th>
                            <th class="number-cell">Налог. нагрузка, %</th>
                            <th class="number-cell">Чистая прибыль, ₽</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, data in top_results %}
                        <tr>
                            <td class="regime-name">{{ name }}</td>
                            <td class="number-cell">{{ format_number(data.total_burden) }}</td>
                            <td class="number-cell">{{ "%.2f"|format(data.burden_percent) }}%</td>
                            <td class="number-cell">{{ format_number(data.net_profit) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}


        {% if results %}
        <div class="results-section">
            <h2 class="results-title">Сравнение режимов налогообложения</h2>

            <div class="table-wrapper">
                <table id="regimes-table"
                    data-cost-of-goods="{{ components.cost_of_goods or 0 }}"
                    data-rent="{{ components.rent or 0 }}"
                    data-other-expenses="{{ components.other_expenses or 0 }}"
                    data-annual-fot="{{ components.annual_fot or 0 }}"
                    data-insurance-standard="{{ components.insurance_standard or 0 }}"
                    data-owner-extra-1p="{{ components.owner_extra_1p or 0 }}"
                    data-vat-purchases-percent="{{ components.vat_purchases_percent or 0 }}">

                    <thead>
                        <tr>
                            <th>Режим</th>
                            <th class="number-cell">Выручка, ₽</th>
                            <th class="number-cell">Расходы, ₽</th>
                            <th class="number-cell">Налог, ₽</th>
                            <th class="number-cell">НДС, ₽</th>
                            <th class="number-cell">Взносы, ₽</th>
                            <th class="number-cell">Налог. нагрузка, ₽</th>
                            <th class="number-cell">Налог. нагрузка, %</th>
                            <th class="number-cell">Чист. прибыль, ₽</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for regime_name, data, is_available in results %}
                        <tr
                            {% if is_available and data %}
                                class="regime-row"
                                data-regime="{{ regime_name }}"
                                data-revenue="{{ data.revenue }}"
                                data-expenses="{{ data.expenses }}"
                                data-tax="{{ data.tax }}"
                                data-vat="{{ data.vat }}"
                                data-insurance="{{ data.insurance }}"
                                data-total-burden="{{ data.total_burden }}"
                                data-burden-percent="{{ '%.2f'|format(data.burden_percent) }}"
                                data-net-profit="{{ data.net_profit }}"
                            {% endif %}
                        >
                            <td class="regime-name {% if not is_available %}unavailable{% endif %}">
                                {{ regime_name }}
                            </td>
                            {% if is_available and data %}
                                <td class="number-cell">{{ format_number(data.revenue) }}</td>
                                <td class="number-cell">{{ format_number(data.expenses) }}</td>
                                <td class="number-cell">{{ format_number(data.tax) }}</td>
                                <td class="number-cell">{{ format_number(data.vat) }}</td>
                                <td class="number-cell">{{ format_number(data.insurance) }}</td>
                                <td class="number-cell">{{ format_number(data.total_burden) }}</td>
                                <td class="number-cell">{{ "%.2f"|format(data.burden_percent) }}%</td>
                                <td class="number-cell {% if data.net_profit >= 0 %}positive{% else %}negative{% endif %}">
                                    {{ format_number(data.net_profit) }}
                                </td>
                            {% else %}
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <p style="margin-top: 20px; color: #808080; font-size: 13px;">
                * Для режимов УСН и ОСНО страховые взносы включают 30% от ФОТ и, при выручке свыше 300 000 ₽,
                  1% с доходов ИП сверх этой суммы. На АУСН 8% и АУСН 20% эти взносы в расчёт не включаются (0 ₽).<br>
                * АУСН доступен только при выручке до 60 млн ₽ в год и до 5 сотрудников.
            </p>
        </div>
        {% endif %}
    </div>

    <script>
        (function () {
            const monthIds = [
                'purchases_jan', 'purchases_feb', 'purchases_mar', 'purchases_apr',
                'purchases_may', 'purchases_jun', 'purchases_jul', 'purchases_aug',
                'purchases_sep', 'purchases_oct', 'purchases_nov', 'purchases_dec'
            ];

            function recalcCoefficients() {
                let sum = 0;
                monthIds.forEach(function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const val = parseFloat(el.value.replace(',', '.'));
                    if (!isNaN(val) && val > 0) {
                        sum += val;
                    }
                });

                const base = 1200;
                const percent = sum > 0 ? (sum / base * 100) : 0;

                const sumEl = document.getElementById('coef-sum');
                const percentEl = document.getElementById('coef-percent');

                if (sumEl) {
                    sumEl.textContent = sum.toFixed(2);
                }
                if (percentEl) {
                    percentEl.textContent = percent.toFixed(1);
                }

                // Лёгкая цветовая подсветка
                const summary = document.querySelector('.month-summary');
                if (summary) {
                    if (percent === 0) {
                        summary.style.color = '#e0e0e0';
                    } else if (percent >= 90 && percent <= 110) {
                        summary.style.color = '#6bcf7f'; // близко к 100% от 1200
                    } else {
                        summary.style.color = '#ffb86c'; // заметное отклонение
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                monthIds.forEach(function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.addEventListener('input', recalcCoefficients);
                });
                recalcCoefficients();
            });
        })();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const revenueInput = document.getElementById('revenue');
        const percentInput = document.getElementById('other_percent');
        const amountInput = document.getElementById('other_amount');
        const modeInputs = document.getElementsByName('other_mode');

        function updateFromPercent() {
            const revenue = parseFloat(revenueInput.value) || 0;
            const percent = parseFloat(percentInput.value) || 0;
            amountInput.value = (revenue * percent / 100).toFixed(2);
        }

        function updateFromAmount() {
            const revenue = parseFloat(revenueInput.value) || 0;
            const amount = parseFloat(amountInput.value) || 0;
            percentInput.value = revenue > 0 ? (amount / revenue * 100).toFixed(2) : 0;
        }

        function refreshMode() {
            const mode = [...modeInputs].find(r => r.checked).value;
            if (mode === 'percent') {
                percentInput.removeAttribute('readonly');
                amountInput.setAttribute('readonly', true);
                updateFromPercent();
            } else {
                amountInput.removeAttribute('readonly');
                percentInput.setAttribute('readonly', true);
                updateFromAmount();
            }
        }

        percentInput.addEventListener('input', updateFromPercent);
        amountInput.addEventListener('input', updateFromAmount);
        revenueInput.addEventListener('input', refreshMode);

        modeInputs.forEach(r => r.addEventListener('change', refreshMode));

        refreshMode();
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const empInput = document.getElementById('employees');
        const salaryInput = document.getElementById('salary');
        const fotAnnualInput = document.getElementById('fot_annual');
        const fotModeInputs = document.getElementsByName('fot_mode');

        if (!empInput || !salaryInput || !fotAnnualInput || !fotModeInputs.length) {
            return;
        }

        function getFotMode() {
            const checked = Array.from(fotModeInputs).find(r => r.checked);
            return checked ? checked.value : 'staff';
        }

        function updateFotFromStaff() {
            const mode = getFotMode();
            if (mode !== 'staff') {
                return;
            }
            const emp = parseFloat(empInput.value) || 0;
            const sal = parseFloat(salaryInput.value) || 0;
            const annual = emp * sal * 12;
            fotAnnualInput.value = annual ? annual.toFixed(2) : '0.00';
        }

        function refreshFotMode() {
            const mode = getFotMode();
            if (mode === 'staff') {
                empInput.removeAttribute('readonly');
                salaryInput.removeAttribute('readonly');
                fotAnnualInput.setAttribute('readonly', true);
                updateFotFromStaff();
            } else {
                fotAnnualInput.removeAttribute('readonly');
                empInput.removeAttribute('readonly');
                salaryInput.removeAttribute('readonly');
            }
        }

        empInput.addEventListener('input', updateFotFromStaff);
        salaryInput.addEventListener('input', updateFotFromStaff);
        Array.from(fotModeInputs).forEach(r => r.addEventListener('change', refreshFotMode));

        // начальная настройка
        refreshFotMode();
    });
    </script>


    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('regimes-table');
        if (!table) return;

        // Базовые компоненты расходов из data-атрибутов таблицы
        const ds = table.dataset;
        const baseCost      = parseFloat(ds.costOfGoods || 0);
        const baseRent      = parseFloat(ds.rent || 0);
        const baseOther     = parseFloat(ds.otherExpenses || 0);
        const baseFot       = parseFloat(ds.annualFot || 0);
        const baseInsurStd  = parseFloat(ds.insuranceStandard || 0);
        const vatPurchasesPercent = parseFloat(ds.vatPurchasesPercent || 0);

        function fmtMoney(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
        }

        function fmtPercent(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function buildExplanation(regime, data) {
            const revenue      = data.revenue;
            const expenses     = data.expenses;
            const tax          = data.tax;
            const vat          = data.vat;
            const insurance    = data.insurance;
            const totalBurden  = data.totalBurden;
            const burdenPct    = data.burdenPercent;
            const netProfit    = data.netProfit;

            const isAusn = regime.includes('АУСН');
            const isUsnIncomeNoVat = regime.includes('УСН Доходы 6% (общепит)') || regime === 'УСН Доходы 6%';
            const isUsnDrNoVat = regime.includes('УСН Д-Р 15% (общепит)') || regime === 'УСН Д-Р 15%';
            const isUsnIncome5 = regime.includes('УСН Доходы 6% + НДС 5%');
            const isUsnDr5 = regime.includes('УСН Д-Р 15% + НДС 5%');
            const isUsnDr22 = regime.includes('УСН Д-Р 15% + НДС 22%');
            const isOsno = regime.includes('ОСНО');

            const lines = [];

            // 1. Общее описание режима
            if (regime.includes('АУСН 8')) {
                lines.push('<p><strong>Как считается налог:</strong> 8% от выручки. Страховые взносы и взнос 1% с доходов свыше 300 000 ₽ на АУСН не платятся, НДС нет.</p>');
            } else if (regime.includes('АУСН 20')) {
                lines.push('<p><strong>Как считается налог:</strong> помесячно: для каждого месяца налог = max(20% от (доходы − расходы), 3% от доходов месяца). Страховые взносы и взнос 1% с доходов свыше 300 000 ₽ на АУСН не платятся. В таблице показана сумма этих налогов за год.</p>');
            } else if (isUsnIncomeNoVat) {
                lines.push('<p><strong>Как считается налог:</strong> 6% от выручки. НДС не применяется (льгота для общепита). Страховые взносы учитывают 30% от ФОТ и 1% с доходов свыше 300 000 ₽.</p>');
            } else if (isUsnDrNoVat) {
                lines.push('<p><strong>Как считается налог:</strong> 15% от положительной разницы «доходы − расходы». НДС не применяется (льгота для общепита). Страховые взносы учитывают 30% от ФОТ и 1% с доходов свыше 300 000 ₽.</p>');
            } else if (isUsnIncome5) {
                lines.push('<p><strong>Как считается налог:</strong> УСН 6% от выручки + НДС 5% с выручки (без вычетов) + страховые взносы (30% от ФОТ и 1% с доходов свыше 300 000 ₽).</p>');
            } else if (isUsnDr5) {
                lines.push('<p><strong>Как считается налог:</strong> УСН 15% с прибыли (доходы − расходы) + НДС 5% с выручки (без вычетов) + страховые взносы (30% от ФОТ и 1% с доходов свыше 300 000 ₽).</p>');
            } else if (isUsnDr22) {
                lines.push('<p><strong>Как считается налог:</strong> УСН 15% с прибыли (доходы − расходы) + НДС 22%: налог к начислению с выручки минус НДС по закупкам + страховые взносы (30% от ФОТ и 1% с доходов свыше 300 000 ₽).</p>');
            } else if (isOsno) {
                lines.push('<p><strong>Как считается налог:</strong> НДС 22% (к начислению с выручки минус НДС по закупкам) + налог на прибыль 25% с прибыли после учёта расходов и НДС + страховые взносы (30% от ФОТ и 1% с доходов свыше 300 000 ₽).</p>');
            }

            // 2. Расходы
            let expenseParts;
            if (isAusn) {
                expenseParts =
                    `${fmtMoney(baseCost)} ₽ (себестоимость) + ` +
                    `${fmtMoney(baseRent)} ₽ (аренда) + ` +
                    `${fmtMoney(baseOther)} ₽ (прочие) + ` +
                    `${fmtMoney(baseFot)} ₽ (ФОТ)`;
            } else {
                // 1% считаем как разницу между общими взносами и 30% ФОТ
                const owner1p = Math.max(0, insurance - baseInsurStd);
                expenseParts =
                    `${fmtMoney(baseCost)} ₽ (себестоимость) + ` +
                    `${fmtMoney(baseRent)} ₽ (аренда) + ` +
                    `${fmtMoney(baseOther)} ₽ (прочие) + ` +
                    `${fmtMoney(baseFot)} ₽ (ФОТ) + ` +
                    `${fmtMoney(baseInsurStd)} ₽ (страховые взносы 30% от ФОТ) + ` +
                    `${fmtMoney(owner1p)} ₽ (взнос 1% с доходов свыше 300 000 ₽)`;
            }

            lines.push(
                `<p><strong>Доходы:</strong> ${fmtMoney(revenue)} ₽</p>`,
                `<p><strong>Расходы (без налогов):</strong> ${fmtMoney(expenses)} ₽ = ${expenseParts}</p>`
            );

            // 3. Налог по режиму
            if (regime.includes('АУСН 8')) {
                lines.push(`<p><strong>Налог по режиму:</strong> 8% от выручки = ${fmtMoney(revenue)} × 8% = ${fmtMoney(tax)} ₽</p>`);
            } else if (isUsnIncomeNoVat || isUsnIncome5) {
                lines.push(`<p><strong>Налог по режиму:</strong> 6% от выручки = ${fmtMoney(revenue)} × 6% = ${fmtMoney(tax)} ₽</p>`);
            } else if (isUsnDrNoVat || isUsnDr5 || isUsnDr22) {
                const base = revenue - expenses;
                lines.push(
                    `<p><strong>Налог по режиму:</strong> 15% от положительной разницы (доходы − расходы). ` +
                    `База = ${fmtMoney(revenue)} − ${fmtMoney(expenses)} = ${fmtMoney(base)} ₽; ` +
                    `налог = max(0, база) × 15% = ${fmtMoney(tax)} ₽</p>`
                );
            } else if (regime.includes('АУСН 20')) {
                lines.push(`<p><strong>Налог по режиму:</strong> сумма помесячных налогов: max(20% × (доходы − расходы), 3% × доходов месяца) по каждому месяцу. В год получается ${fmtMoney(tax)} ₽.</p>`);
            } else if (isOsno) {
                lines.push(
                    `<p><strong>Налог по режиму (налог на прибыль):</strong> 25% с прибыли после учёта расходов и НДС. ` +
                    `В таблице показана сумма налога на прибыль за год: ${fmtMoney(tax)} ₽.</p>`
                );
            } else {
                lines.push(`<p><strong>Налог по режиму:</strong> ${fmtMoney(tax)} ₽</p>`);
            }

            // 4. НДС
            if (isUsnIncome5 || isUsnDr5) {
                const vatRate = 5;
                const vatCharged = revenue * vatRate / (100 + vatRate);
                lines.push(
                    `<p><strong>НДС 5%:</strong> к начислению с выручки = ${fmtMoney(revenue)} × 5 / 105 ≈ ${fmtMoney(vatCharged)} ₽; ` +
                    `вычетов по закупкам нет (льгота 5%), поэтому НДС к уплате ≈ ${fmtMoney(vat)} ₽.</p>`
                );
            } else if (isUsnDr22 || isOsno) {
                const vatRate = 22;
                const vatCharged = revenue * vatRate / (100 + vatRate);
                const purchasesBase = baseCost * vatPurchasesPercent / 100;
                const vatDeductible = purchasesBase * vatRate / (100 + vatRate);
                lines.push(
                    `<p><strong>НДС 22%:</strong> ` +
                    `к начислению = ${fmtMoney(revenue)} × 22 / 122 ≈ ${fmtMoney(vatCharged)} ₽; ` +
                    `к вычету по закупкам = себестоимость с НДС ${fmtMoney(baseCost)} ₽ × доля с НДС ${fmtPercent(vatPurchasesPercent)}% × 22 / 122 ≈ ${fmtMoney(vatDeductible)} ₽; ` +
                    `НДС к уплате ≈ ${fmtMoney(vat)} ₽.</p>`
                );
            } else if (regime.includes('АУСН')) {
                lines.push('<p><strong>НДС:</strong> при АУСН НДС не уплачивается.</p>');
            } else if (!vat || vat === 0) {
                lines.push('<p><strong>НДС:</strong> в этом режиме НДС не начисляется.</p>');
            }

            // 5. Страховые взносы
            if (isAusn) {
                lines.push('<p><strong>Страховые взносы:</strong> на АУСН страховые взносы 30% от ФОТ и взнос 1% с доходов свыше 300 000 ₽ не уплачиваются и в расчётах не учитываются.</p>');
            } else if (insurance > 0) {
                const owner1p = Math.max(0, insurance - baseInsurStd);
                if (owner1p > 0) {
                    lines.push(
                        `<p><strong>Страховые взносы:</strong> 30% от ФОТ = ${fmtMoney(baseFot)} ₽ × 30% = ${fmtMoney(baseInsurStd)} ₽; ` +
                        `1% с доходов свыше 300 000 ₽ = max(0, ${fmtMoney(revenue)} − 300 000 ₽) × 1% ≈ ${fmtMoney(owner1p)} ₽; ` +
                        `итого страховые взносы = ${fmtMoney(baseInsurStd)} + ${fmtMoney(owner1p)} = ${fmtMoney(insurance)} ₽.</p>`
                    );
                } else {
                    lines.push(
                        `<p><strong>Страховые взносы:</strong> 30% от ФОТ = ${fmtMoney(baseFot)} ₽ × 30% = ${fmtMoney(insurance)} ₽; ` +
                        `1% с доходов свыше 300 000 ₽ не взимается, так как доходы, учитываемые для 1%, не превышают 300 000 ₽.</p>`
                    );
                }
            } else {
                lines.push('<p><strong>Страховые взносы:</strong> не начисляются (ФОТ = 0 и доход ≤ 300 000 ₽).</p>');
            }

            // 6. Налоговая нагрузка и чистая прибыль
            lines.push(
                `<p><strong>Налоговая нагрузка:</strong> налог по режиму + НДС + страховые взносы = ` +
                `${fmtMoney(tax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽ ` +
                `(${fmtPercent(burdenPct)}% от выручки). Эта сумма показывает все налоги и взносы за год.</p>`
            );

            lines.push(
                `<p><strong>Чистая прибыль:</strong> доходы − расходы (без налогов) − налог по режиму − НДС = ` +
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(vat)} = ${fmtMoney(netProfit)} ₽.</p>`
            );

            return lines.join('');
        }

        function toggleDetails(row) {
            const next = row.nextElementSibling;
            if (next && next.classList.contains('details-row')) {
                next.remove();
                return;
            }

            const regime = row.dataset.regime || '';

            const data = {
                revenue:        parseFloat(row.dataset.revenue || 0),
                expenses:       parseFloat(row.dataset.expenses || 0),
                tax:            parseFloat(row.dataset.tax || 0),
                vat:            parseFloat(row.dataset.vat || 0),
                insurance:      parseFloat(row.dataset.insurance || 0),
                totalBurden:    parseFloat(row.dataset.totalBurden || 0),
                burdenPercent:  parseFloat(row.dataset.burdenPercent || 0),
                netProfit:      parseFloat(row.dataset.netProfit || 0),
            };

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row';

            const cell = document.createElement('td');
            cell.colSpan = 9;
            const box = document.createElement('div');
            box.className = 'details-box';

            const title = document.createElement('div');
            title.className = 'details-title';
            title.textContent = `Расчёт для: ${regime}`;

            const body = document.createElement('div');
            body.innerHTML = buildExplanation(regime, data);

            box.appendChild(title);
            box.appendChild(body);
            cell.appendChild(box);
            detailsRow.appendChild(cell);

            row.parentNode.insertBefore(detailsRow, row.nextElementSibling);
        }

        table.querySelectorAll('tr.regime-row').forEach(function (row) {
            row.addEventListener('click', function () {
                toggleDetails(row);
            });
        });
    });
    </script>

</body>
</html>
