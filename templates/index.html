<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор налогов для ИП</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #ffffff;
            font-weight: 600;
        }

        .description {
            color: #a0a0a0;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .error {
            background-color: #2d1515;
            border: 1px solid #5a2121;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section {
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 500;
        }

        input[type="number"],
        input[type="text"] {
            background-color: #0f0f0f;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            color: #e0e0e0;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .fot-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #151515;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .fot-label {
            grid-column: 1 / -1;
            font-size: 15px;
            color: #d0d0d0;
            font-weight: 600;
            margin-bottom: -10px;
        }

        .month-help {
            grid-column: 1 / -1;
            font-size: 12px;
            color: #808080;
            margin-top: -5px;
        }

        .month-summary {
            grid-column: 1 / -1;
            font-size: 12px;
            margin-top: 4px;
        }

        .month-summary span {
            font-weight: 600;
        }

        button {
            background-color: #3a7bc8;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: #4a8fd8;
        }

        button:active {
            transform: scale(0.98);
        }

        .results-section {
            margin-top: 40px;
        }

        .results-note {
            background-color: #131313;
            border: 1px solid #2a2a2a;
            border-left: 3px solid #4a9eff;
            border-radius: 10px;
            padding: 16px 18px;
            margin-bottom: 25px;
            color: #c8c8c8;
            font-size: 13px;
            line-height: 1.5;
        }

        .results-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
            background-color: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th {
            background-color: #0f0f0f;
            color: #b0b0b0;
            font-weight: 600;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #2a2a2a;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #2a2a2a;
            font-size: 14px;
        }

        tr:hover {
            background-color: #222222;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .regime-name {
            font-weight: 500;
            color: #ffffff;
        }

        .number-cell {
            text-align: center;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .unavailable {
            color: #666666;
            font-style: italic;
        }

        .positive {
            color: #6bcf7f;
        }

        .negative {
            color: #ff6b6b;
        }

        .details-row td {
            background-color: #141414;
            border-top: none;
            border-bottom: 1px solid #2a2a2a;
            padding-top: 8px;
            padding-bottom: 12px;
        }

        .details-box {
            font-size: 13px;
            color: #c0c0c0;
            line-height: 1.5;
        }

        .details-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
        }

        .details-box p {
            margin-bottom: 4px;
        }

        .details-box p:last-child {
            margin-bottom: 0;
        }

        .markdown-explanation {
            white-space: pre-wrap;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .regime-row {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .form-section {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .fot-group {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 20px;
            }

            .table-wrapper {
                padding: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Калькулятор налогов для ИП</h1>
        <p class="description">Сравнение режимов налогообложения с учётом законодательства 2026 года</p>

        {% if error %}
        <div class="error">
            {{ error }}
        </div>
        {% endif %}

        <div class="form-section">
            <form method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="revenue">Выручка в год, ₽ *</label>
                        <input type="number" id="revenue" name="revenue" step="0.01" required
                               value="{{ form_data.revenue if form_data else '0' }}">
                    </div>

                    <div class="form-group">
                        <label for="cost_percent">Себестоимость, % от выручки</label>
                        <input type="number" id="cost_percent" name="cost_percent" step="0.01" min="0" max="100"
                               value="{{ form_data.cost_percent if form_data else '0' }}">
                    </div>

                    <div class="form-group">
                        <label for="vat_purchases_percent">Процент закупок с НДС, %</label>
                        <input type="number" id="vat_purchases_percent" name="vat_purchases_percent" step="0.01" min="0" max="100"
                               value="{{ form_data.vat_purchases_percent if form_data else '0' }}">
                    </div>

                    <div class="form-group">
                        <label for="rent">Аренда в год, ₽</label>
                        <input type="number" id="rent" name="rent" step="0.01"
                               value="{{ form_data.rent if form_data else '0' }}">
                    </div>

                    <div class="form-group">
                        <label for="fixed_contrib">Фиксированный взнос за ИП в год, ₽</label>
                        <input type="number" id="fixed_contrib" name="fixed_contrib" step="0.01" min="0"
                               value="{{ form_data.fixed_contrib if form_data else '57390' }}">
                    </div>

                    {% set transition_mode = form_data.transition_mode | default('none') %}
                    <div class="fot-group" style="grid-column: 1 / -1; margin-top: 10px;">
                        <div class="fot-label">Учёт перехода на режим</div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label style="margin-bottom: 10px;">Что учитывать при смене режима</label>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label>
                                    <input type="radio" name="transition_mode" value="none"
                                        {% if not form_data or transition_mode == 'none' %}checked{% endif %}>
                                    Не учитывать
                                </label>
                                <label>
                                    <input type="radio" name="transition_mode" value="vat"
                                        {% if transition_mode == 'vat' %}checked{% endif %}>
                                    Учитывать накопленный НДС к вычету
                                </label>
                                <label>
                                    <input type="radio" name="transition_mode" value="stock"
                                        {% if transition_mode == 'stock' %}checked{% endif %}>
                                    Учитывать сумму себестоимости остатков товара
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="accumulated_vat_credit">Накопленный НДС к вычету, ₽</label>
                            <input
                                type="number"
                                id="accumulated_vat_credit"
                                name="accumulated_vat_credit"
                                step="0.01"
                                min="0"
                                value="{{ form_data.accumulated_vat_credit if form_data else '0' }}"
                                {% if transition_mode != 'vat' %}readonly{% endif %}
                            >
                        </div>

                        <div class="form-group">
                            <label for="stock_expense_amount">Сумма себестоимости остатков товара, ₽</label>
                            <input
                                type="number"
                                id="stock_expense_amount"
                                name="stock_expense_amount"
                                step="0.01"
                                min="0"
                                value="{{ form_data.stock_expense_amount if form_data else '0' }}"
                                {% if transition_mode != 'stock' %}readonly{% endif %}
                            >
                        </div>

                        <p class="month-help" style="grid-column: 1 / -1; margin-top: 4px;">
                            При переходе на новый режим можно учесть либо накопленный входящий НДС за последние 3 года,
                            либо стоимость подтверждённых товарных остатков как единовременный расход.
                            Для подтверждения нужны: накладные, счета-фактуры, карточки складского учёта,
                            акт инвентаризации остатков на дату перехода.
                        </p>
                    </div>

                    <div class="fot-group">
                        <div class="fot-label">Прочие расходы</div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div style="margin-bottom: 10px;">
                                <label style="margin-right: 20px;">
                                    <input type="radio" name="other_mode" value="percent"
                                        {% if form_data.other_mode != 'absolute' %}checked{% endif %}>
                                    В процентах
                                </label>
                                <label>
                                    <input type="radio" name="other_mode" value="absolute"
                                        {% if form_data.other_mode == 'absolute' %}checked{% endif %}>
                                    В рублях
                                </label>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label for="other_percent">Проценты (%)</label>
                                    <input type="number" id="other_percent" name="other_percent" step="0.01" min="0" max="100"
                                        value="{{ form_data.other_percent if form_data else '0' }}"
                                        {% if form_data.other_mode == 'absolute' %}readonly{% endif %}>
                                </div>

                                <div>
                                    <label for="other_amount">Сумма (₽ в год)</label>
                                    <input type="number" id="other_amount" name="other_amount" step="0.01" min="0"
                                        value="{{ form_data.other_amount if form_data else '0' }}"
                                        {% if form_data.other_mode != 'absolute' %}readonly{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="fot-group">
                        <div class="fot-label">Фонд оплаты труда (ФОТ)</div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Способ задания ФОТ</label>
                            <div style="margin-top: 4px; margin-bottom: 12px;">
                                <label style="margin-right: 20px;">
                                    <input type="radio" name="fot_mode" value="staff"
                                        {% if form_data.fot_mode != 'annual' %}checked{% endif %}>
                                    По сотрудникам (количество × оклад)
                                </label>
                                <label>
                                    <input type="radio" name="fot_mode" value="annual"
                                        {% if form_data.fot_mode == 'annual' %}checked{% endif %}>
                                    ФОТ суммой за год
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="employees">Количество сотрудников</label>
                            <input type="number" id="employees" name="employees" min="0" step="1"
                                value="{{ form_data.employees if form_data else '0' }}">
                        </div>

                        <div class="form-group">
                            <label for="salary">Оклад одного сотрудника в месяц, ₽</label>
                            <input type="number" id="salary" name="salary" step="0.01"
                                value="{{ form_data.salary if form_data else '0' }}">
                        </div>

                        <div class="form-group">
                            <label for="fot_annual">ФОТ за год, ₽</label>
                            <input type="number" id="fot_annual" name="fot_annual" step="0.01" min="0"
                                value="{{ form_data.fot_annual if form_data else '' }}">
                        </div>

                        <p class="month-help" style="grid-column: 1 / -1; margin-top: 4px;">
                            В режиме «по сотрудникам» ФОТ за год считается как:
                            <strong>количество сотрудников × оклад × 12</strong> и подставляется автоматически.
                            В режиме «ФОТ суммой за год» используется только введённая сумма — поля сотрудников и оклады
                            на расчёт не влияют.
                        </p>
                    </div>


                    <div class="fot-group">
                        <div class="fot-label">
                            Коэффициент закупок по месяцам (100 — обычный месяц, для АУСН 20%)
                        </div>

                        <div class="form-group">
                            <label for="purchases_jan">Январь</label>
                            <input type="number" id="purchases_jan" name="purchases_jan" step="0.01" min="0"
                                   value="{{ form_data.purchases_jan if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_feb">Февраль</label>
                            <input type="number" id="purchases_feb" name="purchases_feb" step="0.01" min="0"
                                   value="{{ form_data.purchases_feb if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_mar">Март</label>
                            <input type="number" id="purchases_mar" name="purchases_mar" step="0.01" min="0"
                                   value="{{ form_data.purchases_mar if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_apr">Апрель</label>
                            <input type="number" id="purchases_apr" name="purchases_apr" step="0.01" min="0"
                                   value="{{ form_data.purchases_apr if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_may">Май</label>
                            <input type="number" id="purchases_may" name="purchases_may" step="0.01" min="0"
                                   value="{{ form_data.purchases_may if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_jun">Июнь</label>
                            <input type="number" id="purchases_jun" name="purchases_jun" step="0.01" min="0"
                                   value="{{ form_data.purchases_jun if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_jul">Июль</label>
                            <input type="number" id="purchases_jul" name="purchases_jul" step="0.01" min="0"
                                   value="{{ form_data.purchases_jul if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_aug">Август</label>
                            <input type="number" id="purchases_aug" name="purchases_aug" step="0.01" min="0"
                                   value="{{ form_data.purchases_aug if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_sep">Сентябрь</label>
                            <input type="number" id="purchases_sep" name="purchases_sep" step="0.01" min="0"
                                   value="{{ form_data.purchases_sep if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_oct">Октябрь</label>
                            <input type="number" id="purchases_oct" name="purchases_oct" step="0.01" min="0"
                                   value="{{ form_data.purchases_oct if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_nov">Ноябрь</label>
                            <input type="number" id="purchases_nov" name="purchases_nov" step="0.01" min="0"
                                   value="{{ form_data.purchases_nov if form_data else '100' }}">
                        </div>

                        <div class="form-group">
                            <label for="purchases_dec">Декабрь</label>
                            <input type="number" id="purchases_dec" name="purchases_dec" step="0.01" min="0"
                                   value="{{ form_data.purchases_dec if form_data else '100' }}">
                        </div>

                        <p class="month-help">
                            Укажите <strong>относительную нагрузку закупок</strong> по месяцам.
                            Значение <strong>100</strong> означает обычный уровень закупок.
                            Если в каком-то месяце закупок в 2 раза больше среднего — поставьте <strong>200</strong>,
                            если в 2 раза меньше — <strong>50</strong>.
                            Сумма значений может быть любой — калькулятор сам нормализует их.
                        </p>

                        <p class="month-summary">
                            Сумма коэффициентов: <span id="coef-sum">–</span>
                            (<span id="coef-percent">–</span>% от базового уровня 1200)
                        </p>
                    </div>
                </div>

                <button type="submit">Рассчитать</button>
            </form>
        </div>

        {% if results %}
        <div class="results-note">
            В расчётах предполагается, что ИП платит фиксированный взнос за себя в размере
            <strong>{{ format_number(components.fixed_contrib or 0) }}</strong> ₽ в год.
            Этот платёж обязателен для всех рассматриваемых режимов и включён в общую налоговую нагрузку.
        </div>
        {% endif %}

        {% if top_results %}
        <div class="results-section">
            <h2 class="results-title">Топ-5 режимов с минимальной налоговой нагрузкой</h2>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Режим</th>
                            <th class="number-cell">Налог. нагрузка, ₽</th>
                            <th class="number-cell">Налог. нагрузка, %</th>
                            <th class="number-cell">Чистая прибыль, ₽</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, data in top_results %}
                        <tr>
                            <td class="regime-name">{{ name }}</td>
                            <td class="number-cell">{{ format_number(data.total_burden) }}</td>
                            <td class="number-cell">{{ "%.2f"|format(data.burden_percent) }}%</td>
                            <td class="number-cell">{{ format_number(data.net_profit) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}


        {% if results %}
        <div class="results-section">
            <h2 class="results-title">Сравнение режимов налогообложения</h2>

            <div class="table-wrapper">
                <table id="regimes-table"
                    data-cost-of-goods="{{ components.cost_of_goods or 0 }}"
                    data-rent="{{ components.rent or 0 }}"
                    data-other-expenses="{{ components.other_expenses or 0 }}"
                    data-annual-fot="{{ components.annual_fot or 0 }}"
                    data-insurance-standard="{{ components.insurance_standard or 0 }}"
                    data-fixed-contrib="{{ components.fixed_contrib or 0 }}"
                    data-vat-purchases-percent="{{ components.vat_purchases_percent or 0 }}"
                    data-accumulated-vat-credit="{{ components.accumulated_vat_credit or 0 }}"
                    data-stock-extra="{{ components.stock_extra or 0 }}"
                    data-transition-mode="{{ components.transition_mode or 'none' }}">

                    <thead>
                        <tr>
                            <th>Режим</th>
                            <th class="number-cell">Выручка, ₽</th>
                            <th class="number-cell">Расходы, ₽</th>
                            <th class="number-cell">Налог, ₽</th>
                            <th class="number-cell">НДС, ₽</th>
                            <th class="number-cell">Взносы, ₽</th>
                            <th class="number-cell">Налог. нагрузка, ₽</th>
                            <th class="number-cell">Налог. нагрузка, %</th>
                            <th class="number-cell">Чист. прибыль, ₽</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for regime_name, data, is_available in results %}
                        <tr
                            {% if is_available and data %}
                                class="regime-row"
                                data-regime="{{ regime_name }}"
                                data-revenue="{{ data.revenue }}"
                                data-expenses="{{ data.expenses }}"
                                data-tax="{{ data.tax }}"
                                data-vat="{{ data.vat }}"
                                data-insurance="{{ data.insurance }}"
                                data-total-burden="{{ data.total_burden }}"
                                data-burden-percent="{{ '%.2f'|format(data.burden_percent) }}"
                                data-net-profit="{{ data.net_profit }}"
                                data-owner-extra="{{ data.owner_extra or 0 }}"
                                data-owner-extra-base="{{ data.owner_extra_base or 0 }}"
                                data-usn-regular-tax="{{ data.usn_regular_tax or 0 }}"
                                data-usn-min-tax="{{ data.usn_min_tax or 0 }}"
                                data-tax-initial="{{ data.tax_initial or 0 }}"
                                data-tax-reduction="{{ data.tax_reduction or 0 }}"
                                data-tax-reduction-limit="{{ data.tax_reduction_limit or 0 }}"
                                data-fixed-contrib="{{ data.fixed_contrib or 0 }}"
                                data-fixed-reduction="{{ data.fixed_contrib_reduction or 0 }}"
                                data-ndfl-base="{{ data.ndfl_base or 0 }}"
                                data-ndfl-tax="{{ data.ndfl_tax or data.tax or 0 }}"
                                data-income-no-vat="{{ data.income_without_vat or 0 }}"
                                data-expenses-no-vat="{{ data.expenses_without_vat or 0 }}"
                            {% endif %}
                        >
                            <td class="regime-name {% if not is_available %}unavailable{% endif %}">
                                {{ regime_name }}
                            </td>
                            {% if is_available and data %}
                                <td class="number-cell">{{ format_number(data.revenue) }}</td>
                                <td class="number-cell">{{ format_number(data.expenses) }}</td>
                                <td class="number-cell">{{ format_number(data.tax) }}</td>
                                <td class="number-cell">{{ format_number(data.vat) }}</td>
                                <td class="number-cell">{{ format_number(data.insurance) }}</td>
                                <td class="number-cell">{{ format_number(data.total_burden) }}</td>
                                <td class="number-cell">{{ "%.2f"|format(data.burden_percent) }}%</td>
                                <td class="number-cell {% if data.net_profit >= 0 %}positive{% else %}negative{% endif %}">
                                    {{ format_number(data.net_profit) }}
                                </td>
                            {% else %}
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <p style="margin-top: 20px; color: #808080; font-size: 13px;">
                * Страховые взносы рассчитаны как 30% от ФОТ + дополнительный 1% с превышения базы свыше 300 000 ₽ (для режимов «доходы» — с выручки, для «доходы минус расходы» и ОСНО — с прибыли) + фиксированный взнос за ИП, указанный во вводных данных.<br>
                * АУСН доступен только при выручке до 60 млн ₽ в год и до 5 сотрудников.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Переключение переходных сумм -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const modeInputs = document.querySelectorAll('input[name="transition_mode"]');
        const vatInput = document.getElementById('accumulated_vat_credit');
        const stockInput = document.getElementById('stock_expense_amount');

        if (!modeInputs.length || !vatInput || !stockInput) {
            return;
        }

        function setReadonly(el, state) {
            if (!el) return;
            if (state) {
                el.setAttribute('readonly', true);
            } else {
                el.removeAttribute('readonly');
            }
        }

        function resetValue(el) {
            if (!el) return;
            el.value = '0';
        }

        function handleModeChange() {
            const checked = Array.from(modeInputs).find(r => r.checked);
            const mode = checked ? checked.value : 'none';

            if (mode === 'vat') {
                setReadonly(vatInput, false);
                setReadonly(stockInput, true);
                resetValue(stockInput);
            } else if (mode === 'stock') {
                setReadonly(stockInput, false);
                setReadonly(vatInput, true);
                resetValue(vatInput);
            } else {
                setReadonly(vatInput, true);
                setReadonly(stockInput, true);
                resetValue(vatInput);
                resetValue(stockInput);
            }
        }

        modeInputs.forEach(input => {
            input.addEventListener('change', handleModeChange);
        });

        handleModeChange();
    });
    </script>

    <!-- Коэффициенты закупок -->
    <script>
        (function () {
            const monthIds = [
                'purchases_jan', 'purchases_feb', 'purchases_mar', 'purchases_apr',
                'purchases_may', 'purchases_jun', 'purchases_jul', 'purchases_aug',
                'purchases_sep', 'purchases_oct', 'purchases_nov', 'purchases_dec'
            ];

            function recalcCoefficients() {
                let sum = 0;
                monthIds.forEach(function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const val = parseFloat(el.value.replace(',', '.'));
                    if (!isNaN(val) && val > 0) {
                        sum += val;
                    }
                });

                const base = 1200;
                const percent = sum > 0 ? (sum / base * 100) : 0;

                const sumEl = document.getElementById('coef-sum');
                const percentEl = document.getElementById('coef-percent');

                if (sumEl) {
                    sumEl.textContent = sum.toFixed(2);
                }
                if (percentEl) {
                    percentEl.textContent = percent.toFixed(1);
                }

                // Лёгкая цветовая подсветка
                const summary = document.querySelector('.month-summary');
                if (summary) {
                    if (percent === 0) {
                        summary.style.color = '#e0e0e0';
                    } else if (percent >= 90 && percent <= 110) {
                        summary.style.color = '#6bcf7f'; // близко к 100% от 1200
                    } else {
                        summary.style.color = '#ffb86c'; // заметное отклонение
                    }
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                monthIds.forEach(function (id) {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.addEventListener('input', recalcCoefficients);
                });
                recalcCoefficients();
            });
        })();
    </script>

    <!-- Связка прочих расходов % / ₽ -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const revenueInput = document.getElementById('revenue');
        const percentInput = document.getElementById('other_percent');
        const amountInput = document.getElementById('other_amount');
        const modeInputs = document.getElementsByName('other_mode');

        function updateFromPercent() {
            const revenue = parseFloat(revenueInput.value) || 0;
            const percent = parseFloat(percentInput.value) || 0;
            amountInput.value = (revenue * percent / 100).toFixed(2);
        }

        function updateFromAmount() {
            const revenue = parseFloat(revenueInput.value) || 0;
            const amount = parseFloat(amountInput.value) || 0;
            percentInput.value = revenue > 0 ? (amount / revenue * 100).toFixed(2) : 0;
        }

        function refreshMode() {
            const mode = [...modeInputs].find(r => r.checked).value;
            if (mode === 'percent') {
                percentInput.removeAttribute('readonly');
                amountInput.setAttribute('readonly', true);
                updateFromPercent();
            } else {
                amountInput.removeAttribute('readonly');
                percentInput.setAttribute('readonly', true);
                updateFromAmount();
            }
        }

        percentInput.addEventListener('input', updateFromPercent);
        amountInput.addEventListener('input', updateFromAmount);
        revenueInput.addEventListener('input', refreshMode);

        modeInputs.forEach(r => r.addEventListener('change', refreshMode));

        refreshMode();
    });
    </script>

    <!-- Связка ФОТ -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const empInput = document.getElementById('employees');
        const salaryInput = document.getElementById('salary');
        const fotAnnualInput = document.getElementById('fot_annual');
        const fotModeInputs = document.getElementsByName('fot_mode');

        if (!empInput || !salaryInput || !fotAnnualInput || !fotModeInputs.length) {
            return;
        }

        function getFotMode() {
            const checked = Array.from(fotModeInputs).find(r => r.checked);
            return checked ? checked.value : 'staff';
        }

        function updateFotFromStaff() {
            const mode = getFotMode();
            if (mode !== 'staff') {
                return;
            }
            const emp = parseFloat(empInput.value) || 0;
            const sal = parseFloat(salaryInput.value) || 0;
            const annual = emp * sal * 12;
            fotAnnualInput.value = annual ? annual.toFixed(2) : '0.00';
        }

        function refreshFotMode() {
            const mode = getFotMode();
            if (mode === 'staff') {
                empInput.removeAttribute('readonly');
                salaryInput.removeAttribute('readonly');
                fotAnnualInput.setAttribute('readonly', true);
                updateFotFromStaff();
            } else {
                fotAnnualInput.removeAttribute('readonly');
                empInput.removeAttribute('readonly');
                salaryInput.removeAttribute('readonly');
            }
        }

        empInput.addEventListener('input', updateFotFromStaff);
        salaryInput.addEventListener('input', updateFotFromStaff);
        Array.from(fotModeInputs).forEach(r => r.addEventListener('change', refreshFotMode));

        // начальная настройка
        refreshFotMode();
    });
    </script>

    <!-- Расшифровка режимов -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('regimes-table');
        if (!table) return;

        // Базовые компоненты расходов из data-атрибутов таблицы
        const ds = table.dataset;
        const baseCost      = parseFloat(ds.costOfGoods || 0);
        const baseRent      = parseFloat(ds.rent || 0);
        const baseOther     = parseFloat(ds.otherExpenses || 0);
        const baseFot       = parseFloat(ds.annualFot || 0);
        const baseInsurStd  = parseFloat(ds.insuranceStandard || 0);
        const baseFixedContrib = parseFloat(ds.fixedContrib || 0);
        const vatPurchasesPercent = parseFloat(ds.vatPurchasesPercent || 0);
        const accumulatedVatCredit = parseFloat(ds.accumulatedVatCredit || 0);
        const tableStockExtra   = parseFloat(ds.stockExtra || 0);
        const transitionMode = ds.transitionMode || 'none';

        function fmtMoney(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
        }

        function fmtPercent(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderMarkdown(lines) {
            return `<pre class="markdown-explanation">${lines.join('\n')}\n</pre>`;
        }

        function buildAusn8Markdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const fixedContrib = params.fixedContrib || 0;
            const burdenPercentText = fmtPercent(burdenPct);

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (АУСН 8%)',
                '',
                '## 1. Вводные данные',
                'Режим: АУСН 8% (доходы).',
                '',
                'Учитывается:',
                '- Налог 8% от выручки.',
                '- НДС не применяется.',
                '- Фиксированный взнос ИП за себя не уменьшает налог, но добавляется к итоговой нагрузке отдельной строкой.',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                '',
                '## 4. Расчёт налога АУСН 8%',
                'Налог по АУСН:',
                `${fmtMoney(revenue)} × 8% = ${fmtMoney(tax)} ₽.`,
                '',
                '## 5. Страховые взносы',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ — платёж не влияет на налог АУСН и учитывается только в итоговой нагрузке.`,
                '',
                '## 6. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + 0 ₽ + ${fmtMoney(fixedContrib)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 7. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог АУСН − фиксированный взнос за ИП.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(fixedContrib)} = ${fmtMoney(netProfit)} ₽.`,
            ];

            return renderMarkdown(lines);
        }

        function buildAusn20Markdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const fixedContrib = params.fixedContrib || 0;
            const burdenPercentText = fmtPercent(burdenPct);
            const annualBase = revenue - expenses;
            const positiveBase = Math.max(annualBase, 0);
            const tax20 = positiveBase * 0.20;
            const minTax = revenue * 0.03;
            const comparisonText = tax20 > minTax ? 'больше' : (tax20 < minTax ? 'меньше' : 'равен');
            const chosenTax = tax20 > minTax ? tax20 : minTax;

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (АУСН 20%)',
                '',
                '## 1. Вводные данные',
                'Режим: АУСН 20% (доходы минус расходы).',
                '',
                'Учитывается:',
                '- Налог считается: 20% от прибыли, но не меньше 3% от выручки.',
                '- НДС не применяется.',
                '- Фиксированный взнос ИП за себя не уменьшает налог и добавляется к итоговой нагрузке отдельной строкой.',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                '',
                '## 4. Расчёт налога АУСН 20%',
                'Налоговая база за год:',
                `${fmtMoney(revenue)} ₽ − ${fmtMoney(expenses)} ₽ = ${fmtMoney(annualBase)} ₽.`,
                '',
                'Налог 20% от разницы:',
                `${fmtMoney(positiveBase)} ₽ × 20% = ${fmtMoney(tax20)} ₽.`,
                '',
                'Минимальный налог 3% от доходов:',
                `${fmtMoney(revenue)} ₽ × 3% = ${fmtMoney(minTax)} ₽.`,
                '',
                'Фактический налог к уплате:',
                `так как налог 20% (${fmtMoney(tax20)} ₽) ${comparisonText} минимального налога (${fmtMoney(minTax)} ₽), ` +
                `к уплате принимается ${fmtMoney(chosenTax)} ₽. В таблице показана именно эта сумма: ${fmtMoney(tax)} ₽ за год.`,
                '',
                '## 5. Страховые взносы',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ — платёж не влияет на налоговую базу АУСН 20% и учитывается только в «налоговой нагрузке».`,
                '',
                '## 6. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + 0 ₽ + ${fmtMoney(fixedContrib)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 7. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог АУСН − фиксированный взнос за ИП.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(fixedContrib)} = ${fmtMoney(netProfit)} ₽.`,
            ];

            return renderMarkdown(lines);
        }

        function buildUsnIncomeMarkdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const taxInitial = params.taxInitial || revenue * 0.06;
            const taxReduction = params.taxReduction || 0;
            const taxReductionLimit = params.taxReductionLimit || (taxInitial * 0.50);
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const ownerExtra = params.ownerExtra || 0;
            const ownerExtraBase = params.ownerExtraBase || 0;
            const fixedContrib = params.fixedContrib || 0;
            const fixedContribReduction = params.fixedContribReduction || 0;
            const burdenPercentText = fmtPercent(burdenPct);
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(ownerExtra)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const ownerBaseLine = `${fmtMoney(ownerExtraBase)} ₽ − 300 000 ₽`;
            const reductionLimited = baseInsurStd >= taxReductionLimit && Math.abs(taxReduction - taxReductionLimit) <= 0.01;
            const hasEmployees = baseFot > 0;
            const fixedReductionIntro = hasEmployees
                ? 'Так как есть сотрудники, фиксированный взнос может уменьшить налог не более чем на 50% от начисленной суммы.'
                : 'Сотрудников нет, поэтому фиксированный взнос может уменьшить налог вплоть до 0 ₽.';
            const standardReductionApplied = Math.min(baseInsurStd, taxReductionLimit);
            const fixedAvailable = hasEmployees
                ? Math.max(taxReductionLimit - standardReductionApplied, 0)
                : Math.max(taxInitial - standardReductionApplied, 0);

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (УСН Доходы 6%)',
                '',
                '## 1. Вводные данные',
                'Режим: УСН 6% (доходы).',
                '',
                'Учитывается:',
                '- Налог УСН 6% от выручки.',
                '- НДС не применяется.',
                '- Страховые взносы: 30% от ФОТ, 1% с доходов свыше 300 000 ₽ и фиксированный взнос за ИП.',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                `- Взнос 1% с доходов свыше 300 000 ₽: ${fmtMoney(ownerExtra)} ₽.`,
                `- Фиксированный взнос за ИП: ${fmtMoney(fixedContrib)} ₽.`,
                '',
                `Фиксированный взнос уменьшает налоговую базу (учтён в расходах) и добавлен к общей налоговой нагрузке как отдельный обязательный платёж.`,
                '',
                '## 4. Расчёт налога УСН 6%',
                'Налог без уменьшения:',
                `${fmtMoney(revenue)} × 6% = ${fmtMoney(taxInitial)} ₽.`,
                '',
                'Сумма страховых взносов, участвующая в уменьшении налога (30% от ФОТ):',
                `${fmtMoney(baseInsurStd)} ₽.`,
                '',
                'Максимальное уменьшение (не более 50% от начисленного налога):',
                `${fmtMoney(taxInitial)} ₽ × 50% = ${fmtMoney(taxReductionLimit)} ₽.`,
            ];

            if (reductionLimited) {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ превышает или равна максимальному допустимому уменьшению (${fmtMoney(taxReductionLimit)} ₽), налог может быть уменьшен только на ${fmtMoney(taxReduction)} ₽.`
                );
            } else {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ меньше максимального допустимого уменьшения (${fmtMoney(taxReductionLimit)} ₽), налог уменьшается на ${fmtMoney(taxReduction)} ₽.`
                );
            }

            lines.push(
                '',
                'Фиксированный взнос за ИП:',
                `Сумма взноса: ${fmtMoney(fixedContrib)} ₽.`,
                fixedReductionIntro,
                hasEmployees
                    ? `Доступный лимит уменьшения за счёт фиксированного взноса: ${fmtMoney(fixedAvailable)} ₽, использовано ${fmtMoney(fixedContribReduction)} ₽.`
                    : `В расчёте налог уменьшен на ${fmtMoney(fixedContribReduction)} ₽ за счёт этого взноса.`,
                'Сам взнос при этом всё равно уплачивается и добавлен к общей налоговой нагрузке.',
                '',
                'Налог к уплате по УСН 6%:',
                `${fmtMoney(taxInitial)} ₽ − ${fmtMoney(taxReduction)} ₽ = ${fmtMoney(tax)} ₽.`,
                '',
                '## 5. Страховые взносы',
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                `(${ownerBaseLine}) × 1% = ${fmtMoney(ownerExtra)} ₽.`,
                '',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ (указан во вводных данных).`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                '## 6. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + 0 ₽ + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 7. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог УСН.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildUsnIncome5Markdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const taxInitial = params.taxInitial || revenue * 0.06;
            const taxReduction = params.taxReduction || 0;
            const taxReductionLimit = params.taxReductionLimit || (taxInitial * 0.50);
            const vat = params.vat || 0;
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const ownerExtra = params.ownerExtra || 0;
            const ownerExtraBase = params.ownerExtraBase || 0;
            const fixedContrib = params.fixedContrib || 0;
            const fixedContribReduction = params.fixedContribReduction || 0;
            const burdenPercentText = fmtPercent(burdenPct);
            const ownerBaseLine = `${fmtMoney(ownerExtraBase)} ₽ − 300 000 ₽`;
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(ownerExtra)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const vatRate = 5;
            const vatCharged = revenue * vatRate / (100 + vatRate);
            const reductionLimited = baseInsurStd >= taxReductionLimit && Math.abs(taxReduction - taxReductionLimit) <= 0.01;
            const hasEmployees = baseFot > 0;
            const fixedReductionIntro = hasEmployees
                ? 'Так как есть сотрудники, фиксированный взнос может уменьшить налог не более чем на 50% от начисленной суммы.'
                : 'Сотрудников нет, поэтому фиксированный взнос может уменьшить налог вплоть до 0 ₽.';
            const standardReductionApplied = Math.min(baseInsurStd, taxReductionLimit);
            const fixedAvailable = hasEmployees
                ? Math.max(taxReductionLimit - standardReductionApplied, 0)
                : Math.max(taxInitial - standardReductionApplied, 0);

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (УСН Доходы 6% + НДС 5%)',
                '',
                '## 1. Вводные данные',
                'Режим: УСН 6% + НДС 5%.',
                '',
                'Учитывается:',
                '- Налог УСН 6% от выручки.',
                '- НДС 5% начисляется с выручки (без вычетов).',
                '- Страховые взносы: 30% от ФОТ, 1% с доходов свыше 300 000 ₽ и фиксированный взнос за ИП.',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                `- Взнос 1% с доходов свыше 300 000 ₽: ${fmtMoney(ownerExtra)} ₽.`,
                '',
                '## 4. Расчёт налога УСН 6%',
                'Налог без уменьшения:',
                `${fmtMoney(revenue)} × 6% = ${fmtMoney(taxInitial)} ₽.`,
                '',
                'Сумма страховых взносов, участвующая в уменьшении налога (30% от ФОТ):',
                `${fmtMoney(baseInsurStd)} ₽.`,
                '',
                'Максимальное уменьшение (не более 50% от начисленного налога):',
                `${fmtMoney(taxInitial)} ₽ × 50% = ${fmtMoney(taxReductionLimit)} ₽.`,
            ];

            if (reductionLimited) {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ превышает или равна максимальному допустимому уменьшению (${fmtMoney(taxReductionLimit)} ₽), налог может быть уменьшен только на ${fmtMoney(taxReduction)} ₽.`
                );
            } else {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ меньше максимального допустимого уменьшения (${fmtMoney(taxReductionLimit)} ₽), налог уменьшается на ${fmtMoney(taxReduction)} ₽.`
                );
            }

            lines.push(
                '',
                'Фиксированный взнос за ИП:',
                `Сумма взноса: ${fmtMoney(fixedContrib)} ₽.`,
                fixedReductionIntro,
                hasEmployees
                    ? `Доступный лимит уменьшения за счёт фиксированного взноса: ${fmtMoney(fixedAvailable)} ₽, использовано ${fmtMoney(fixedContribReduction)} ₽.`
                    : `В расчёте налог уменьшен на ${fmtMoney(fixedContribReduction)} ₽ за счёт этого взноса.`,
                'Сам взнос при этом остаётся отдельным обязательным платежом и добавлен к налоговой нагрузке.',
                '',
                'Налог к уплате по УСН 6%:',
                `${fmtMoney(taxInitial)} ₽ − ${fmtMoney(taxReduction)} ₽ = ${fmtMoney(tax)} ₽.`,
                '',
                '## 5. Расчёт НДС 5%',
                '',
                '### 5.1. НДС к начислению',
                'Формула: выручка × 5 / 105.',
                '',
                `${fmtMoney(revenue)} × 5 / 105 = ${fmtMoney(vatCharged)} ₽.`,
                '',
                '### 5.2. НДС к вычету',
                'В этом режиме вычеты по НДС не применяются (льгота 5%).',
                '',
                '### 5.3. НДС к уплате',
                'НДС к уплате:',
                `${fmtMoney(vatCharged)} − 0 ₽ = ${fmtMoney(vat)} ₽.`,
                '',
                '## 6. Страховые взносы',
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                `(${ownerBaseLine}) × 1% = ${fmtMoney(ownerExtra)} ₽.`,
                '',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ (указан во вводных данных).`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                '## 7. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 8. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог УСН − НДС.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(vat)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildUsnIncome22Markdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const taxInitial = params.taxInitial || revenue * 0.06;
            const taxReduction = params.taxReduction || 0;
            const taxReductionLimit = params.taxReductionLimit || (taxInitial * 0.50);
            const vat = params.vat || 0;
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const ownerExtra = params.ownerExtra || 0;
            const ownerExtraBase = params.ownerExtraBase || 0;
            const fixedContrib = params.fixedContrib || 0;
            const fixedContribReduction = params.fixedContribReduction || 0;
            const vatPurchasesPercent = params.vatPurchasesPercent || 0;
            const accumulatedVatCredit = params.accumulatedVatCredit || 0;
            const transitionMode = params.transitionMode || 'none';
            const burdenPercentText = fmtPercent(burdenPct);
            const ownerBaseLine = `${fmtMoney(ownerExtraBase)} ₽ − 300 000 ₽`;
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(ownerExtra)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const vatRate = 22;
            const vatCharged = revenue * vatRate / (100 + vatRate);
            const purchasesBase = baseCost * (vatPurchasesPercent / 100);
            const vatDeductible = purchasesBase * vatRate / (100 + vatRate);
            const extraCreditApplied = transitionMode === 'vat' ? accumulatedVatCredit : 0;
            const creditPart = extraCreditApplied > 0
                ? ` − ${fmtMoney(extraCreditApplied)} ₽ (накопленный НДС)`
                : '';
            const reductionLimited = baseInsurStd >= taxReductionLimit && Math.abs(taxReduction - taxReductionLimit) <= 0.01;
            const hasEmployees = baseFot > 0;
            const fixedReductionIntro = hasEmployees
                ? 'Так как есть сотрудники, фиксированный взнос может уменьшить налог не более чем на 50% от начисленной суммы.'
                : 'Сотрудников нет, поэтому фиксированный взнос может уменьшить налог вплоть до 0 ₽.';
            const standardReductionApplied = Math.min(baseInsurStd, taxReductionLimit);
            const fixedAvailable = hasEmployees
                ? Math.max(taxReductionLimit - standardReductionApplied, 0)
                : Math.max(taxInitial - standardReductionApplied, 0);

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (УСН Доходы 6% + НДС 22%)',
                '',
                '## 1. Вводные данные',
                'Режим: УСН 6% + НДС 22%.',
                '',
                'Учитывается:',
                '- Налог УСН 6% от выручки.',
                '- НДС 22% начисляется как на ОСНО: с выручки минус входящий НДС по закупкам.',
                '- Страховые взносы: 30% от ФОТ, 1% с доходов свыше 300 000 ₽ и фиксированный взнос за ИП.',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                `- Взнос 1% с доходов свыше 300 000 ₽: ${fmtMoney(ownerExtra)} ₽.`,
                '',
                '## 4. Расчёт налога УСН 6%',
                'Налог без уменьшения:',
                `${fmtMoney(revenue)} × 6% = ${fmtMoney(taxInitial)} ₽.`,
                '',
                'Сумма страховых взносов, участвующая в уменьшении налога (30% от ФОТ):',
                `${fmtMoney(baseInsurStd)} ₽.`,
                '',
                'Максимальное уменьшение (не более 50% от начисленного налога):',
                `${fmtMoney(taxInitial)} ₽ × 50% = ${fmtMoney(taxReductionLimit)} ₽.`,
            ];

            if (reductionLimited) {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ превышает или равна максимальному допустимому уменьшению (${fmtMoney(taxReductionLimit)} ₽), налог может быть уменьшен только на ${fmtMoney(taxReduction)} ₽.`
                );
            } else {
                lines.push(
                    '',
                    'Фактическое уменьшение налога:',
                    `так как сумма страховых взносов (30% от ФОТ) = ${fmtMoney(baseInsurStd)} ₽ меньше максимального допустимого уменьшения (${fmtMoney(taxReductionLimit)} ₽), налог уменьшается на ${fmtMoney(taxReduction)} ₽.`
                );
            }

            lines.push(
                '',
                'Фиксированный взнос за ИП:',
                `Сумма взноса: ${fmtMoney(fixedContrib)} ₽.`,
                fixedReductionIntro,
                hasEmployees
                    ? `Доступный лимит уменьшения за счёт фиксированного взноса: ${fmtMoney(fixedAvailable)} ₽, использовано ${fmtMoney(fixedContribReduction)} ₽.`
                    : `В расчёте налог уменьшен на ${fmtMoney(fixedContribReduction)} ₽ за счёт этого взноса.`,
                'Сам взнос при этом остаётся отдельным обязательным платежом и добавлен к налоговой нагрузке.',
                '',
                'Налог к уплате по УСН 6%:',
                `${fmtMoney(taxInitial)} ₽ − ${fmtMoney(taxReduction)} ₽ = ${fmtMoney(tax)} ₽.`,
                '',
                '## 5. Расчёт НДС 22%',
                '',
                '### 5.1. НДС к начислению',
                'Формула: выручка × 22 / 122.',
                '',
                `${fmtMoney(revenue)} × 22 / 122 = ${fmtMoney(vatCharged)} ₽.`,
                '',
                '### 5.2. НДС к вычету по закупкам',
                `Себестоимость с НДС: ${fmtMoney(baseCost)} ₽.`,
                `Доля закупок с НДС: ${fmtPercent(vatPurchasesPercent)}%.`,
                '',
                'НДС к вычету:',
                `${fmtMoney(baseCost)} × ${fmtPercent(vatPurchasesPercent)}% × 22 / 122 = ${fmtMoney(vatDeductible)} ₽.`,
            );

            if (extraCreditApplied > 0) {
                lines.push(
                    '',
                    'Дополнительный вычет при переходе:',
                    `накопленный входящий НДС = ${fmtMoney(extraCreditApplied)} ₽.`
                );
            }

            lines.push(
                '',
                '### 5.3. НДС к уплате',
                'НДС к уплате:',
                `${fmtMoney(vatCharged)} − ${fmtMoney(vatDeductible)}${creditPart} = ${fmtMoney(vat)} ₽.`,
                '',
                '## 6. Страховые взносы',
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                `(${ownerBaseLine}) × 1% = ${fmtMoney(ownerExtra)} ₽.`,
                '',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ (указан во вводных данных).`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                '## 7. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 8. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог УСН − НДС.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(vat)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildUsnDrMarkdown(params, options) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const vat = params.vat || 0;
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const ownerExtra = params.ownerExtra || 0;
            const ownerExtraBase = params.ownerExtraBase || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const fixedContrib = params.fixedContrib || 0;
            const stockExtra = params.stockExtra || 0;
            const usnRegularTax = params.usnRegularTax || 0;
            const usnMinTax = params.usnMinTax || 0;
            const vatPurchasesPercent = params.vatPurchasesPercent || 0;
            const accumulatedVatCredit = params.accumulatedVatCredit || 0;
            const transitionMode = params.transitionMode || 'none';
            const title = options.title;
            const includeVatSection = !!options.includeVatSection;
            const vatRate = options.vatRate;
            const burdenPercentText = fmtPercent(burdenPct);
            const ownerBaseLine = `${fmtMoney(ownerExtraBase)} ₽ − 300 000 ₽`;
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(ownerExtra)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const stockPart = stockExtra > 0 ? stockExtra : 0;
            const usnBase = revenue - expenses - stockPart;
            const positiveBase = Math.max(usnBase, 0);
            const regularTax = usnRegularTax || positiveBase * 0.15;
            const minTax = usnMinTax || revenue * 0.01;
            const usesMinTax = Math.abs(tax - minTax) < Math.abs(tax - regularTax);
            const lines = [
                `# Пояснение к расчёту налоговой нагрузки (${title})`,
                '',
                '## 1. Вводные данные',
                `Режим: ${title}.`,
                '',
                'Учитывается:',
                '- УСН 15% с прибыли (доходы − расходы).',
                includeVatSection
                    ? (vatRate === 5
                        ? '- НДС 5%: начисляется с выручки без вычетов.'
                        : '- НДС 22%: начисленный с выручки минус входящий по закупкам.')
                    : '- НДС не применяется.',
                '- Страховые взносы: 30% от ФОТ, 1% с доходов свыше 300 000 ₽ и фиксированный взнос за ИП (учитывается и в расходах, и в итоговой нагрузке).',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                `- Взнос 1% с доходов свыше 300 000 ₽: ${fmtMoney(ownerExtra)} ₽.`,
            ];

            if (stockPart > 0) {
                lines.push(
                    '',
                    `Дополнительно: при переходе учтено единовременное списание остатков товара на ${fmtMoney(stockPart)} ₽ (уменьшает налоговую базу, но не входит в расходы).`
                );
            }

            lines.push(
                '',
                '## 4. Расчёт налога УСН 15%',
                'Налоговая база:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)}${stockPart > 0 ? ` − ${fmtMoney(stockPart)} (остатки)` : ''} = ${fmtMoney(usnBase)} ₽.`,
                '',
                'Налог по УСН 15%:',
                `${fmtMoney(positiveBase)} × 15% = ${fmtMoney(regularTax)} ₽.`,
                '',
                'Минимальный налог 1% от доходов:',
                `${fmtMoney(revenue)} × 1% = ${fmtMoney(minTax)} ₽.`,
                '',
                usesMinTax
                    ? `Так как налог по ставке 15% (${fmtMoney(regularTax)} ₽) меньше минимального, к уплате принимается минимальный налог ${fmtMoney(tax)} ₽.`
                    : 'Так как налог по ставке 15% не меньше минимального, к уплате берётся результат по ставке 15%.',
            );

            if (includeVatSection && vatRate === 5) {
                const vatCharged = revenue * vatRate / (100 + vatRate);
                lines.push(
                    '',
                    '## 5. Расчёт НДС 5%',
                    '',
                    '### 5.1. НДС к начислению',
                    'Формула: выручка × 5 / 105.',
                    '',
                    `${fmtMoney(revenue)} × 5 / 105 = ${fmtMoney(vatCharged)} ₽.`,
                    '',
                    '### 5.2. НДС к вычету',
                    'В этом режиме вычеты по НДС не применяются (льгота 5%).',
                    '',
                    '### 5.3. НДС к уплате',
                    'НДС к уплате:',
                    `${fmtMoney(vatCharged)} − 0 ₽ = ${fmtMoney(vat)} ₽.`,
                );
            } else if (includeVatSection && vatRate === 22) {
                const vatCharged = revenue * vatRate / (100 + vatRate);
                const purchasesBase = baseCost * (vatPurchasesPercent / 100);
                const vatDeductible = purchasesBase * vatRate / (100 + vatRate);
                const creditPart = accumulatedVatCredit > 0 && transitionMode === 'vat'
                    ? ` − ${fmtMoney(accumulatedVatCredit)} ₽ (накопленный НДС)`
                    : '';

                lines.push(
                    '',
                    '## 5. Расчёт НДС 22%',
                    '',
                    '### 5.1. НДС к начислению',
                    'Формула: выручка × 22 / 122.',
                    '',
                    `${fmtMoney(revenue)} × 22 / 122 = ${fmtMoney(vatCharged)} ₽.`,
                    '',
                    '### 5.2. НДС к вычету по закупкам',
                    `Себестоимость с НДС: ${fmtMoney(baseCost)} ₽.`,
                    `Доля закупок с НДС: ${fmtPercent(vatPurchasesPercent)}%.`,
                    '',
                    'НДС к вычету:',
                    `${fmtMoney(baseCost)} × ${fmtPercent(vatPurchasesPercent)}% × 22 / 122 = ${fmtMoney(vatDeductible)} ₽.`,
                );

                if (accumulatedVatCredit > 0 && transitionMode === 'vat') {
                    lines.push(
                        '',
                        `Дополнительный вычет при переходе: накопленный входящий НДС = ${fmtMoney(accumulatedVatCredit)} ₽.`
                    );
                }

                lines.push(
                    '',
                    '### 5.3. НДС к уплате',
                    'НДС к уплате:',
                    `${fmtMoney(vatCharged)} − ${fmtMoney(vatDeductible)}${creditPart} = ${fmtMoney(vat)} ₽.`,
                );
            }

            lines.push(
                '',
                `${includeVatSection ? '## 6.' : '## 5.'} Страховые взносы`,
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                `(${ownerBaseLine}) × 1% = ${fmtMoney(ownerExtra)} ₽.`,
                '',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ (уменьшает налоговую базу и добавлен в итоговую нагрузку).`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                `${includeVatSection ? '## 7.' : '## 6.'} Совокупная налоговая нагрузка`,
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                `${includeVatSection ? '## 8.' : '## 7.'} Чистая прибыль`,
                'Формула:',
                includeVatSection
                    ? 'доходы − расходы (без налогов) − налог УСН − НДС.'
                    : 'доходы − расходы (без налогов) − налог УСН.',
                '',
                'Расчёт:',
                includeVatSection
                    ? `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(vat)} = ${fmtMoney(netProfit)} ₽.`
                    : `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildUsnDrNoVatMarkdown(params) {
            return buildUsnDrMarkdown(params, {
                title: 'УСН «доходы минус расходы» 15%',
                includeVatSection: false,
            });
        }

        function buildUsnDr5Markdown(params) {
            return buildUsnDrMarkdown(params, {
                title: 'УСН «доходы минус расходы» 15% + НДС 5%',
                includeVatSection: true,
                vatRate: 5,
            });
        }

        function buildUsnDr22Markdown(params) {
            return buildUsnDrMarkdown(params, {
                title: 'УСН «доходы минус расходы» 15% + НДС 22%',
                includeVatSection: true,
                vatRate: 22,
            });
        }

        function buildOsnoMarkdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const tax = params.tax || 0;
            const vat = params.vat || 0;
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const ownerExtra = params.ownerExtra || 0;
            const ownerExtraBase = params.ownerExtraBase || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const fixedContrib = params.fixedContrib || 0;
            const vatPurchasesPercent = params.vatPurchasesPercent || 0;
            const stockExtra = params.stockExtra || 0;
            const accumulatedVatCredit = params.accumulatedVatCredit || 0;
            const transitionMode = params.transitionMode || 'none';

            const stockPart = stockExtra > 0 ? stockExtra : 0;
            const profitBase = revenue - expenses - stockPart - vat;
            const positiveProfitBase = Math.max(profitBase, 0);
            const vatRate = 22;
            const vatCharged = revenue * vatRate / (100 + vatRate);
            const purchasesBase = baseCost * (vatPurchasesPercent / 100);
            const vatDeductible = purchasesBase * vatRate / (100 + vatRate);
            const burdenPercentText = fmtPercent(burdenPct);
            const ownerBaseLine = `${fmtMoney(ownerExtraBase)} ₽ − 300 000 ₽`;
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(ownerExtra)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const creditPart = transitionMode === 'vat' && accumulatedVatCredit > 0
                ? ` − ${fmtMoney(accumulatedVatCredit)} ₽ (накопленный НДС)`
                : '';

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (ОСНО + НДС 22% (ООО))',
                '',
                '## 1. Вводные данные',
                'Режим: ОСНО + НДС 22% (ООО).',
                '',
                'Учитывается:',
                '- НДС 22%: начисленный с выручки минус входящий по закупкам.',
                '- Налог на прибыль 25% с базы после расходов, НДС и списания остатков (если применимо).',
                '- Страховые взносы: 30% от ФОТ, 1% с доходов свыше 300 000 ₽ и фиксированный взнос за ИП (учтён в расходах и добавлен в нагрузку).',
                '',
                '## 2. Доходы',
                `Доходы за период: ${fmtMoney(revenue)} ₽.`,
                '',
                '## 3. Расходы (без налогов)',
                `Итого расходы: ${fmtMoney(expenses)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость: ${fmtMoney(baseCost)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                `- Взнос 1% с доходов свыше 300 000 ₽: ${fmtMoney(ownerExtra)} ₽.`,
                `- Фиксированный взнос за ИП: ${fmtMoney(fixedContrib)} ₽.`,
                '',
                `Фиксированный взнос уменьшает налоговую базу по налогу на прибыль и дополнительно учтён как обязательный платёж.`,
            ];

            if (stockPart > 0) {
                lines.push(
                    '',
                    `Дополнительно: при переходе учтено единовременное списание остатков товара на ${fmtMoney(stockPart)} ₽ (уменьшает налоговую базу по налогу на прибыль, но не входит в расходы).`
                );
            }

            lines.push(
                '',
                '## 4. Расчёт налога на прибыль 25%',
                'Налоговая база:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)}${stockPart > 0 ? ` − ${fmtMoney(stockPart)} (остатки)` : ''} − ${fmtMoney(vat)} (НДС) = ${fmtMoney(profitBase)} ₽.`,
                '',
                'Налог на прибыль:',
                `${fmtMoney(positiveProfitBase)} × 25% = ${fmtMoney(tax)} ₽.`,
                '',
                '## 5. Расчёт НДС 22%',
                '',
                '### 5.1. НДС к начислению',
                'Формула: выручка × 22 / 122.',
                '',
                `${fmtMoney(revenue)} × 22 / 122 = ${fmtMoney(vatCharged)} ₽.`,
                '',
                '### 5.2. НДС к вычету по закупкам',
                `Себестоимость с НДС: ${fmtMoney(baseCost)} ₽.`,
                `Доля закупок с НДС: ${fmtPercent(vatPurchasesPercent)}%.`,
                '',
                'НДС к вычету:',
                `${fmtMoney(baseCost)} × ${fmtPercent(vatPurchasesPercent)}% × 22 / 122 = ${fmtMoney(vatDeductible)} ₽.`,
            );

            if (transitionMode === 'vat' && accumulatedVatCredit > 0) {
                lines.push(
                    '',
                    `Дополнительный вычет при переходе: накопленный входящий НДС = ${fmtMoney(accumulatedVatCredit)} ₽.`
                );
            }

            lines.push(
                '',
                '### 5.3. НДС к уплате',
                'НДС к уплате:',
                `${fmtMoney(vatCharged)} − ${fmtMoney(vatDeductible)}${creditPart} = ${fmtMoney(vat)} ₽.`,
                '',
                '## 6. Страховые взносы',
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                `(${ownerBaseLine}) × 1% = ${fmtMoney(ownerExtra)} ₽.`,
                '',
                'Фиксированный взнос за ИП:',
                `${fmtMoney(fixedContrib)} ₽ (учитывается в расходах и добавлен к нагрузке).`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                '## 7. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(tax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 8. Чистая прибыль',
                'Формула:',
                'доходы − расходы (без налогов) − налог УСН − НДС.',
                '',
                'Расчёт:',
                `${fmtMoney(revenue)} − ${fmtMoney(expenses)} − ${fmtMoney(tax)} − ${fmtMoney(vat)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildOsnoIpMarkdown(params) {
            const revenue = params.revenue || 0;
            const expenses = params.expenses || 0;
            const ndflTax = params.ndflTax || params.tax || 0;
            const vat = params.vat || 0;
            const insurance = params.insurance || 0;
            const totalBurden = params.totalBurden || 0;
            const burdenPct = params.burdenPct || 0;
            const netProfit = params.netProfit || 0;
            const baseCost = params.baseCost || 0;
            const baseRent = params.baseRent || 0;
            const baseOther = params.baseOther || 0;
            const baseFot = params.baseFot || 0;
            const baseInsurStd = params.baseInsurStd || 0;
            const fixedContrib = params.fixedContrib || 0;
            const vatPurchasesPercent = params.vatPurchasesPercent || 0;
            const stockExtra = params.stockExtra || 0;
            const accumulatedVatCredit = params.accumulatedVatCredit || 0;
            const transitionMode = params.transitionMode || 'none';
            const incomeWithoutVat = params.incomeWithoutVat || 0;
            const expensesWithoutVat = params.expensesWithoutVat || 0;

            const stockPart = stockExtra > 0 ? stockExtra : 0;
            const vatRate = 22;
            const vatCharged = revenue * vatRate / (100 + vatRate);
            const purchasesBase = baseCost * (vatPurchasesPercent / 100);
            const vatDeductible = purchasesBase * vatRate / (100 + vatRate);
            const creditPart = transitionMode === 'vat' && accumulatedVatCredit > 0
                ? ` − ${fmtMoney(accumulatedVatCredit)} ₽ (накопленный НДС)`
                : '';
            const baseWithout1pct = Math.max(incomeWithoutVat - expensesWithoutVat - fixedContrib, 0);
            const excessOverThreshold = Math.max(baseWithout1pct - 300000, 0);
            const extra1pctCalc = excessOverThreshold * 0.01;
            const ndflBaseCalc = Math.max(baseWithout1pct - extra1pctCalc, 0);
            const insuranceBreakdown = `${fmtMoney(baseInsurStd)} ₽ + ${fmtMoney(extra1pctCalc)} ₽ + ${fmtMoney(fixedContrib)} ₽`;
            const burdenPercentText = fmtPercent(burdenPct);
            const ndflEffective = ndflBaseCalc > 0 ? (ndflTax / ndflBaseCalc * 100) : 0;
            const ndflScale = [
                'до 2 400 000 ₽ — 13%',
                '2 400 001–5 000 000 ₽ — 15%',
                '5 000 001–20 000 000 ₽ — 18%',
                '20 000 001–50 000 000 ₽ — 20%',
                'свыше 50 000 000 ₽ — 22%',
            ];

            const lines = [
                '# Пояснение к расчёту налоговой нагрузки (ОСНО + НДС 22% (ИП))',
                '',
                '## 1. Вводные данные',
                'Режим: ОСНО + НДС 22% (ИП).',
                '',
                'Учитывается:',
                '- НДС рассчитывается так же, как у юридических лиц: начисление с выручки и вычеты по закупкам.',
                '- Вместо налога на прибыль рассчитывается НДФЛ ИП по прогрессивной шкале.',
                '- В налоговую базу по НДФЛ включены расходы без НДС, фиксированный взнос ИП и дополнительный 1% взнос.',
                '',
                '## 2. Доходы',
                `Выручка (с НДС): ${fmtMoney(revenue)} ₽.`,
                `Доходы без НДС для расчёта НДФЛ: ${fmtMoney(incomeWithoutVat)} ₽.`,
                '',
                '## 3. Расходы (без НДС)',
                `Расходы, уменьшающие базу НДФЛ: ${fmtMoney(expensesWithoutVat)} ₽.`,
                '',
                'Структура расходов:',
                `- Себестоимость (без НДС по облагаемым закупкам): ${fmtMoney(baseCost - vatDeductible)} ₽.`,
                `- Аренда: ${fmtMoney(baseRent)} ₽.`,
                `- Прочие расходы: ${fmtMoney(baseOther)} ₽.`,
                `- ФОТ: ${fmtMoney(baseFot)} ₽.`,
                `- Страховые взносы 30% от ФОТ: ${fmtMoney(baseInsurStd)} ₽.`,
                ...(stockPart > 0 ? [`- Списание остатков товара: ${fmtMoney(stockPart)} ₽.`] : []),
                '',
                '## 4. База ИП и взнос 1% свыше 300 000 ₽',
                '1. База ИП без учёта 1%:',
                `   ${fmtMoney(incomeWithoutVat)} − ${fmtMoney(expensesWithoutVat)} − ${fmtMoney(fixedContrib)} = ${fmtMoney(baseWithout1pct)} ₽.`,
                ...(excessOverThreshold > 0 ? [
                    '',
                    '2. Превышение над 300 000 ₽:',
                    `   ${fmtMoney(baseWithout1pct)} − 300 000 ₽ = ${fmtMoney(excessOverThreshold)} ₽.`,
                    '',
                    '3. Дополнительный взнос 1%:',
                    `   ${fmtMoney(excessOverThreshold)} × 1% = ${fmtMoney(extra1pctCalc)} ₽.`,
                    '',
                    '4. База для НДФЛ:',
                    `   ${fmtMoney(baseWithout1pct)} − ${fmtMoney(extra1pctCalc)} = ${fmtMoney(ndflBaseCalc)} ₽.`,
                    '',
                ] : [
                    '',
                    '2. База не превышает 300 000 ₽, взнос 1% = 0 ₽.',
                    '',
                    '3. База для НДФЛ:',
                    `   ${fmtMoney(baseWithout1pct)} = ${fmtMoney(ndflBaseCalc)} ₽.`,
                    '',
                ]),
                '## 5. Расчёт НДФЛ по прогрессивной шкале',
                `Ступени (2026): ${ndflScale.join(', ')}.`,
                '',
                `Итоговый НДФЛ: ${fmtMoney(ndflTax)} ₽ (эффективная ставка ${fmtPercent(ndflEffective)}%).`,
                '',
                '## 6. Расчёт НДС 22%',
                '',
                '### 6.1. НДС к начислению',
                `${fmtMoney(revenue)} × 22 / 122 = ${fmtMoney(vatCharged)} ₽.`,
                '',
                '### 6.2. НДС к вычету по закупкам',
                `Себестоимость с НДС: ${fmtMoney(baseCost)} ₽.`,
                `Доля закупок с НДС: ${fmtPercent(vatPurchasesPercent)}%.`,
                '',
                'НДС к вычету:',
                `${fmtMoney(baseCost)} × ${fmtPercent(vatPurchasesPercent)}% × 22 / 122 = ${fmtMoney(vatDeductible)} ₽.`,
            ];

            if (transitionMode === 'vat' && accumulatedVatCredit > 0) {
                lines.push(
                    '',
                    `Дополнительный вычет при переходе: накопленный входящий НДС = ${fmtMoney(accumulatedVatCredit)} ₽.`
                );
            }

            lines.push(
                '',
                '### 6.3. НДС к уплате',
                `${fmtMoney(vatCharged)} − ${fmtMoney(vatDeductible)}${creditPart} = ${fmtMoney(vat)} ₽.`,
                '',
                '## 7. Страховые взносы',
                '30% от ФОТ:',
                `${fmtMoney(baseFot)} × 30% = ${fmtMoney(baseInsurStd)} ₽.`,
                '',
                '1% с доходов свыше 300 000 ₽:',
                ...(excessOverThreshold > 0
                    ? [`   ${fmtMoney(excessOverThreshold)} × 1% = ${fmtMoney(extra1pctCalc)} ₽.`]
                    : ['   превышения нет, взнос 1% = 0 ₽.']),
                '',
                'Фиксированный взнос ИП:',
                `${fmtMoney(fixedContrib)} ₽.`,
                '',
                'Итого страховых взносов:',
                `${insuranceBreakdown} = ${fmtMoney(insurance)} ₽.`,
                '',
                '## 8. Совокупная налоговая нагрузка',
                'Сумма налогов и взносов:',
                `${fmtMoney(ndflTax)} + ${fmtMoney(vat)} + ${fmtMoney(insurance)} = ${fmtMoney(totalBurden)} ₽.`,
                '',
                'Доля от выручки:',
                `${fmtMoney(totalBurden)} / ${fmtMoney(revenue)} × 100% = ${burdenPercentText}%.`,
                '',
                '## 9. Чистая прибыль',
                'Формула:',
                'доходы без НДС − расходы без НДС − НДФЛ − фиксированный взнос − взнос 1%.',
                '',
                'Расчёт:',
                `${fmtMoney(incomeWithoutVat)} − ${fmtMoney(expensesWithoutVat)} − ${fmtMoney(ndflTax)} − ${fmtMoney(extra1pctCalc)} − ${fmtMoney(fixedContrib)} = ${fmtMoney(netProfit)} ₽.`,
            );

            return renderMarkdown(lines);
        }

        function buildExplanation(regime, data) {
            const revenue      = data.revenue;
            const expenses     = data.expenses;
            const tax          = data.tax;
            const vat          = data.vat;
            const insurance    = data.insurance;
            const totalBurden  = data.totalBurden;
            const burdenPct    = data.burdenPercent;
            const netProfit    = data.netProfit;
            const ownerExtra   = data.ownerExtra || 0;
            const ownerExtraBase = data.ownerExtraBase || 0;

            const isAusn = regime.includes('АУСН');
            const isUsnIncomeNoVat = regime === 'УСН Доходы 6%';
            const isUsnIncome5 = regime.includes('УСН Доходы 6% + НДС 5%');
            const isUsnIncome22 = regime.includes('УСН Доходы 6% + НДС 22%');
            const isUsnDrNoVat = regime === 'УСН Д-Р 15%' || regime.includes('УСН Д-Р 15%');
            const isUsnDr5 = regime.includes('УСН Д-Р 15% + НДС 5%');
            const isUsnDr22 = regime.includes('УСН Д-Р 15% + НДС 22%');
            const isOsnoCompany = regime.includes('ОСНО + НДС 22% (ООО)');
            const isOsnoIp = regime.includes('ОСНО + НДС 22% (ИП)');

            const stockApplicable =
                transitionMode === 'stock'
                && tableStockExtra > 0
                && (isUsnDrNoVat || isUsnDr5 || isUsnDr22 || isOsnoCompany || isOsnoIp);

            const builderParams = {
                revenue: revenue,
                expenses: expenses,
                tax: tax,
                vat: vat,
                insurance: insurance,
                totalBurden: totalBurden,
                burdenPct: burdenPct,
                netProfit: netProfit,
                ownerExtra: ownerExtra,
                ownerExtraBase: ownerExtraBase,
                baseCost: baseCost,
                baseRent: baseRent,
                baseOther: baseOther,
                baseFot: baseFot,
                baseInsurStd: baseInsurStd,
                stockExtra: stockApplicable ? tableStockExtra : 0,
                transitionMode: transitionMode,
                vatPurchasesPercent: vatPurchasesPercent,
                accumulatedVatCredit: accumulatedVatCredit,
                usnRegularTax: data.usnRegularTax || 0,
                usnMinTax: data.usnMinTax || 0,
                taxInitial: data.taxInitial || 0,
                taxReduction: data.taxReduction || 0,
                taxReductionLimit: data.taxReductionLimit || 0,
                fixedContrib: data.fixedContrib || baseFixedContrib,
                fixedContribReduction: data.fixedContribReduction || 0,
                ndflTax: data.ndflTax || 0,
                ndflBase: data.ndflBase || 0,
                incomeWithoutVat: data.incomeNoVat || 0,
                expensesWithoutVat: data.expensesNoVat || 0,
            };

            if (regime.includes('АУСН 8')) {
                return buildAusn8Markdown(builderParams);
            }
            if (regime.includes('АУСН 20')) {
                return buildAusn20Markdown(builderParams);
            }
            if (isUsnIncomeNoVat) {
                return buildUsnIncomeMarkdown(builderParams);
            }
            if (isUsnIncome5) {
                return buildUsnIncome5Markdown(builderParams);
            }
            if (isUsnIncome22) {
                return buildUsnIncome22Markdown(builderParams);
            }
            if (isUsnDrNoVat) {
                return buildUsnDrNoVatMarkdown(builderParams);
            }
            if (isUsnDr5) {
                return buildUsnDr5Markdown(builderParams);
            }
            if (isUsnDr22) {
                return buildUsnDr22Markdown(builderParams);
            }
            if (isOsnoCompany) {
                return buildOsnoMarkdown(builderParams);
            }
            if (isOsnoIp) {
                return buildOsnoIpMarkdown(builderParams);
            }

            throw new Error(`Неизвестный режим для пояснения: ${regime}`);
        }

        function toggleDetails(row) {
            const next = row.nextElementSibling;
            if (next && next.classList.contains('details-row')) {
                next.remove();
                return;
            }

            const regime = row.dataset.regime || '';

            const data = {
                revenue:        parseFloat(row.dataset.revenue || 0),
                expenses:       parseFloat(row.dataset.expenses || 0),
                tax:            parseFloat(row.dataset.tax || 0),
                vat:            parseFloat(row.dataset.vat || 0),
                insurance:      parseFloat(row.dataset.insurance || 0),
                totalBurden:    parseFloat(row.dataset.totalBurden || 0),
                burdenPercent:  parseFloat(row.dataset.burdenPercent || 0),
                netProfit:      parseFloat(row.dataset.netProfit || 0),
                ownerExtra:     parseFloat(row.dataset.ownerExtra || 0),
                ownerExtraBase: parseFloat(row.dataset.ownerExtraBase || 0),
                usnRegularTax:  parseFloat(row.dataset.usnRegularTax || 0),
                usnMinTax:      parseFloat(row.dataset.usnMinTax || 0),
                taxInitial:     parseFloat(row.dataset.taxInitial || 0),
                taxReduction:   parseFloat(row.dataset.taxReduction || 0),
                taxReductionLimit: parseFloat(row.dataset.taxReductionLimit || 0),
                fixedContrib:   parseFloat(row.dataset.fixedContrib || 0),
                fixedContribReduction: parseFloat(row.dataset.fixedReduction || 0),
                ndflBase:       parseFloat(row.dataset.ndflBase || 0),
                ndflTax:        parseFloat(row.dataset.ndflTax || 0),
                incomeNoVat:    parseFloat(row.dataset.incomeNoVat || 0),
                expensesNoVat:  parseFloat(row.dataset.expensesNoVat || 0),
            };

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row';

            const cell = document.createElement('td');
            cell.colSpan = 9; // 1 колонка с названием + 8 числовых
            const box = document.createElement('div');
            box.className = 'details-box';

            const title = document.createElement('div');
            title.className = 'details-title';
            title.textContent = `Расчёт для: ${regime}`;

            const body = document.createElement('div');
            try {
                body.innerHTML = buildExplanation(regime, data);
            } catch (err) {
                console.error('Ошибка при формировании пояснения:', err);
                body.innerHTML = `<p style="color:#ff6b6b;">Не удалось сформировать пояснение: ${err.message}</p>`;
            }

            box.appendChild(title);
            box.appendChild(body);
            cell.appendChild(box);
            detailsRow.appendChild(cell);

            row.parentNode.insertBefore(detailsRow, row.nextElementSibling);
        }

        table.querySelectorAll('tr.regime-row').forEach(function (row) {
            row.addEventListener('click', function () {
                toggleDetails(row);
            });
        });
    });
    </script>
</body>
</html>
