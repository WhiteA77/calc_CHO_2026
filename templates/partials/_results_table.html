{% if results %}
        <div class="results-section">
            <h2 class="results-title">Сравнение режимов налогообложения</h2>

            <div class="table-controls">
                <div class="top-results-controls table-sort-controls">
                    <span>Сортировать по:</span>
                    <label>
                        <input type="radio" name="regimes-sort" value="tax" checked>
                        Налоговая нагрузка, %
                    </label>
                    <label>
                        <input type="radio" name="regimes-sort" value="profit">
                        Чистая прибыль, ₽
                    </label>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="whatif-block">
                    <div class="whatif-block-title">
                        Потенциальный расчёт до уровня ПСН (рост цены при неизменных расходах)
                    </div>
                    <p class="whatif-block-description">
                        Колонки справа показывают, на сколько нужно повысить цену/выручку и как изменятся доля себестоимости и маржа,
                        чтобы чистая прибыль режима догнала прибыль ПСН — за счёт роста цены при неизменных расходах.
                    </p>
                </div>
                <table id="regimes-table"
                    data-cost-of-goods="{{ components.cost_of_goods or 0 }}"
                    data-rent="{{ components.rent or 0 }}"
                    data-other-expenses="{{ components.other_expenses or 0 }}"
                    data-annual-fot="{{ components.annual_fot or 0 }}"
                    data-insurance-standard="{{ components.insurance_standard or 0 }}"
                    data-fixed-contrib="{{ components.fixed_contrib or 0 }}"
                    data-vat-purchases-percent="{{ components.vat_purchases_percent or 0 }}"
                    data-vat-share-cogs="{{ components.vat_share_cogs if components.vat_share_cogs is not none else ((components.vat_purchases_percent or 0) / 100) }}"
                    data-vat-share-rent="{{ components.vat_share_rent or 1 }}"
                    data-vat-share-other="{{ components.vat_share_other or 1 }}"
                    data-accumulated-vat-credit="{{ components.accumulated_vat_credit or 0 }}"
                    data-stock-extra="{{ components.stock_extra or 0 }}"
                    data-transition-mode="{{ components.transition_mode or 'none' }}">

                    <thead>
                        <tr>
                            <th>Режим</th>
                            <th class="number-cell">Выручка, ₽</th>
                            <th class="number-cell">Расходы, ₽</th>
                            <th class="number-cell">Налог, ₽</th>
                            <th class="number-cell">НДС, ₽</th>
                            <th class="number-cell">Взносы, ₽</th>
                            <th class="number-cell">Налог. нагрузка, ₽</th>
                            <th class="number-cell">Налог. нагрузка, %</th>
                            <th class="number-cell">Чист. прибыль, ₽</th>
                            <th class="number-cell whatif-column whatif-column-start">+к выручке, %</th>
                            <th class="number-cell whatif-column">Себестоимость, % → после роста цены</th>
                            <th class="number-cell whatif-column">Маржа нужна, %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for regime_name, data, is_available in results %}
                        {% set is_target = is_available and data and data.regime_id == 'patent' %}
                        <tr
                            {% if is_available and data %}
                                class="regime-row{% if is_target %} target-regime{% endif %}"
                                data-regime="{{ regime_name }}"
                                data-regime-id="{{ data.regime_id }}"
                                data-revenue="{{ data.revenue }}"
                                data-expenses="{{ data.expenses }}"
                                data-tax="{{ data.tax }}"
                                data-vat="{{ data.vat }}"
                                data-insurance="{{ data.insurance }}"
                                data-total-burden="{{ data.total_burden }}"
                                data-burden-percent="{{ '%.2f'|format(data.burden_percent) }}"
                                data-net-profit="{{ data.net_profit }}"
                                data-owner-extra="{{ data.owner_extra or 0 }}"
                                data-owner-extra-base="{{ data.owner_extra_base or 0 }}"
                                data-usn-regular-tax="{{ data.usn_regular_tax or 0 }}"
                                data-usn-min-tax="{{ data.usn_min_tax or 0 }}"
                                data-tax-initial="{{ data.tax_initial or 0 }}"
                                data-tax-reduction="{{ data.tax_reduction or 0 }}"
                                data-tax-reduction-limit="{{ data.tax_reduction_limit or 0 }}"
                                data-fixed-contrib="{{ data.fixed_contrib or 0 }}"
                                data-fixed-reduction="{{ data.fixed_contrib_reduction or 0 }}"
                                data-ndfl-base="{{ data.ndfl_base or 0 }}"
                                data-ndfl-tax="{{ data.ndfl_tax or data.tax or 0 }}"
                                data-income-no-vat="{{ data.income_without_vat or 0 }}"
                                data-expenses-no-vat="{{ data.expenses_without_vat or 0 }}"
                                data-price-uplift-percent="{{ data.price_uplift_percent if data.price_uplift_percent is not none else '' }}"
                                data-price-uplift-multiplier="{{ data.price_uplift_multiplier if data.price_uplift_multiplier is not none else '' }}"
                                data-price-uplift-unattainable="{{ 1 if data.price_uplift_unattainable else 0 }}"
                                data-gross-margin-current="{{ data.gross_margin_current_percent if data.gross_margin_current_percent is not none else 0 }}"
                                data-gross-margin-needed="{{ data.gross_margin_needed_percent if data.gross_margin_needed_percent is not none else 0 }}"
                                data-gross-margin-delta="{{ data.gross_margin_delta_pp if data.gross_margin_delta_pp is not none else 0 }}"
                                data-cogs-share-current="{{ data.cogs_share_current_percent if data.cogs_share_current_percent is not none else '' }}"
                                data-cogs-share-after="{{ data.cogs_share_after_uplift_percent if data.cogs_share_after_uplift_percent is not none else '' }}"
                            {% endif %}
                        >
                            <td class="regime-name {% if not is_available %}unavailable{% endif %}">
                                <div class="regime-name-main">
                                    <span>{{ regime_name }}</span>
                                    {% if is_target %}
                                        <span class="target-badge">ЦЕЛЬ</span>
                                    {% endif %}
                                </div>
                                {% if is_target %}
                                    <div class="regime-target-note">целевые показатели ПСН</div>
                                {% endif %}
                            </td>
                            {% if is_available and data %}
                                <td class="number-cell">{{ format_number(data.revenue) }}</td>
                                <td class="number-cell">{{ format_number(data.expenses) }}</td>
                                <td class="number-cell">{{ format_number(data.tax) }}</td>
                                <td class="number-cell">{{ format_number(data.vat) }}</td>
                                <td class="number-cell">{{ format_number(data.insurance) }}</td>
                                <td class="number-cell">{{ format_number(data.total_burden) }}</td>
                                <td class="number-cell">{{ "%.2f"|format(data.burden_percent) }}%</td>
                                <td class="number-cell {% if data.net_profit >= 0 %}positive{% else %}negative{% endif %}">
                                    {{ format_number(data.net_profit) }}
                                </td>
                                {% if data.price_uplift_unattainable %}
                                    <td class="number-cell whatif-column whatif-column-start">н/д</td>
                                    <td class="number-cell whatif-column">н/д</td>
                                    <td class="number-cell whatif-column">н/д</td>
                                {% else %}
                                    <td class="number-cell whatif-column whatif-column-start">
                                        {{ "%.2f"|format(data.price_uplift_percent or 0) }}%
                                    </td>
                                    <td class="number-cell whatif-column">
                                        {% if data.cogs_share_current_percent is not none and data.cogs_share_after_uplift_percent is not none %}
                                            {{ "%.1f"|format(data.cogs_share_current_percent) }}% → {{ "%.1f"|format(data.cogs_share_after_uplift_percent) }}%
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td class="number-cell whatif-column">
                                        {{ "%.2f"|format(data.gross_margin_needed_percent or 0) }}%
                                    </td>
                                {% endif %}
                            {% else %}
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable">–</td>
                                <td class="number-cell unavailable whatif-column whatif-column-start">–</td>
                                <td class="number-cell unavailable whatif-column">–</td>
                                <td class="number-cell unavailable whatif-column">–</td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <p class="target-regime-note">
                Режим <strong>ПСН</strong> закреплён сверху и используется как целевой уровень чистой прибыли
                для расчёта потенциальных колонок.
            </p>

            <p style="margin-top: 20px; color: #808080; font-size: 13px;">
                * Страховые взносы рассчитаны как 30% от ФОТ + дополнительный 1% с превышения базы свыше 300 000 ₽ (для режимов «доходы» — с выручки, для «доходы минус расходы» и ОСНО — с прибыли) + фиксированный взнос за ИП, указанный во вводных данных.<br>
                * АУСН доступен только при выручке до 60 млн ₽ в год и до 5 сотрудников.
            </p>
        </div>
        {% endif %}
